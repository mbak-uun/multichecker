
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>???</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/css/uikit.min.css" />
    
    <script src="../config.js"></script>
    <script src="storage.js"></script>
    <script src="scanner.js"></script>
    <script src="walletCEX.js"></script>
    <!-- jQuery 3.6.0 (single include; duplicate at bottom removed) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <!-- (removed: unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js) -->
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <!-- Solana Web3: pinned version 1.70.0 (single include) -->
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.70.0/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.17.11/dist/js/uikit-icons.min.js"></script> 
    
    <link id="favicon" rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/16769/16769999.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="uk-container uk-margin-small-top uk-background-a">
 <!-- Card Bagian Header -->
    <div class="uk-card uk-card-default uk-margin-small header-card uk-card-hover">
        <div class="uk-grid-small uk-flex-middle" uk-grid>
                
                <!-- Kiri: Judul -->
                <div class="uk-width-expand@s uk-width-1-1">
                    <div class="uk-flex uk-flex-middle uk-flex-wrap">
                        <h3 id="judul" class="uk-margin-remove" 
                            style="font-size: 18px; line-height: 1.2; color: #000; font-weight: bold;">
                            MULTISCANNER
                            <img src="https://coopsugar.org/storage/2022/03/new.gif" width="24px" />
                        </h3>
                        <span>[ <b> 
                            <span class="uk-text-danger uk-text-small" id="infoAPP">???</span> 
                        </b> ]</span>
                    </div>
                </div>

                <!-- Kanan: Toolbar icon -->
                <div class="uk-width-auto@s uk-width-1-1">
                    <div class="uk-flex uk-flex-middle uk-flex-wrap uk-flex-right@s" style="gap: 6px;">                        
                       
                        <a href="index.html"><img class="icon" title="MULTISCANNER" width="24px"
                            src="https://cdn-icons-png.flaticon.com/512/30/30279.png" /></a>
                        <img class="icon" id="SettingConfig" title="CONFIG SCANNER" width="24px" src="https://cdn-icons-png.flaticon.com/512/1170/1170635.png" />
                        <img class="icon" id="UpdateWalletCEX" title="UPDATE WALLET CEX" width="24px"
                            src="https://images.freeimages.com/fic/images/icons/2770/ios_7_icons/512/wallet.png"  />
                        <a href="modal.html" target="_blank"><img class="icon" title="MANAJEMEN ASSET" width="24px"
                            src="https://cdn-icons-png.flaticon.com/512/1194/1194711.png" /></a>
                        <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank"><img class="icon" title="BUKA AKSES" width="24px"
                            src="https://cdn-icons-png.flaticon.com/512/9921/9921748.png" /></a>
                        
                         <a href="#" target="_blank" id="ManajemenKoin">
                            <img title="MANAJEMEN KOIN" src="https://cdn-icons-png.flaticon.com/512/5172/5172584.png" width="24px" />
                        </a>    
                         <a href="memory.html" target="_blank">
                            <img title="MANAJEMEN MEMORY" src="https://cdn-icons-png.flaticon.com/512/6736/6736817.png" width="24px" />
                        </a>
                        <a href="#" class="icon" onclick="downloadTokenScannerCSV()" title="DOWNLOAD DATA KOIN" >
                            <img src="https://cdn-icons-png.flaticon.com/512/157/157921.png" width="24px" />
                        </a>
                        <label for="uploadJSON" title="IMPORT DATA KOIN" style="cursor:pointer;">
                            <img src="https://cdn-icons-png.flaticon.com/512/219/219431.png" width="24px"  />
                        </label>
                        <input type="file" id="uploadJSON" accept=".csv,text/csv" style="display:none;" onchange="uploadTokenScannerCSV(event)">
                        <img class="icon" id="reload" title="RESET PROSES" width="24px" src="https://cdn-icons-png.flaticon.com/512/585/585603.png" />
                        <span id="chain-links-container"></span>
                        <img class="icon" id="darkModeToggle" title="Ganti Mode Gelap/Terang" width="24px" src="https://cdn-icons-png.flaticon.com/512/3751/3751403.png" onclick="toggleDarkMode()" /> 
                    </div>
                    
                </div>

        </div>
    </div>

    <!-- Card Bagian Info & Konfigurasi Scanner -->
    <div class="uk-card uk-card-default uk-padding-small uk-card-hover" 
        id="scanner-config" 
        style="border: 1px solid; background-color: #ececec;">

        <div class="uk-grid-small uk-flex-middle" uk-grid>

            <!-- Form Setting -->
            <div class="uk-width-1-1">
                <form id="FormScanner" class="uk-flex uk-flex-middle uk-flex-wrap uk-grid-small" uk-grid>

                    <!-- Pilihan Chain -->
                    <div id="chain-options" class="uk-form-controls uk-flex"></div>
                    <div id="cex-filter" class="uk-form-controls uk-flex uk-margin-small-left"></div>
                    <span class="uk-text-secondary uk-text-bolder">SCANNER:</span>

                    <!-- Checkbox -->
                    <label>
                        <input class="uk-checkbox posisi-check" type="checkbox" value="Actionkiri" checked>
                        <span class="uk-text-success uk-form-label">KIRI</span>
                    </label>
                    <label>
                        <input class="uk-checkbox posisi-check" type="checkbox" value="ActionKanan" checked>
                        <span class="uk-text-success uk-form-label">KANAN</span>
                    </label>
                   
                    <label>
                        <input class="uk-checkbox vol-check" id="checkVOL" type="checkbox">
                        <span class="uk-text-danger uk-form-label">VOL CHECK</span>
                    </label>

                    <!-- Sort Buttons -->
                    <div class="uk-button-group">
                        <label class="uk-button uk-button-small uk-button-default toggle-radio sort-toggle active" data-sort="opt_A">
                            <input class="uk-hidden" type="radio" name="toggle" value="opt_A" checked> A-Z
                        </label>
                        <label class="uk-button uk-button-small uk-button-default toggle-radio sort-toggle" data-sort="opt_B">
                            <input class="uk-hidden" type="radio" name="toggle" value="opt_B"> Z-A
                        </label>
                    </div>

                    <!-- Start/Stop Buttons -->
                    <div class="uk-button-group">
                        <button type="button" id="startSCAN" class="uk-button uk-button-secondary uk-button-small">START</button>
                        <button type="button" id="stopSCAN" style="display: none;"  class="uk-button uk-button-danger uk-button-small">STOP</button>
                    </div>
                </form>
            </div>

            <!-- Progress Bar -->
            <div class="uk-width-1-1 uk-margin-remove-top">
                <div id="progress-container">
                    <div id="progress-bar">
                        <span id="progress-text">0%</span>
                    </div>
                </div>
                <div id="progress" class="uk-margin-remove" style="font-size: 12px; font-weight: bold; color: green;"></div>
            </div>
        </div>
    </div>

    <!-- Bagian untuk menampilkan sinyal DEX -->
    <div class="uk-text uk-text-small uk-margin-small-top" id="sinyal-container">
            <!-- Sinyal DEX akan dimuat di sini -->
    </div>
    
    <div class="uk-grid-small uk-flex uk-flex-middle  uk-margin-small-top" uk-grid id="header-table">
            <!-- Judul dan Jumlah Token -->
            <div class="uk-width-expand">
                <h4 class="uk-heading-line uk-margin-remove" id="daftar">
                    <span style="font-size:medium; ">DAFTAR TOKEN PAIR :: (<span id="tokenCountALL" class="token-count">0</span>)</span>
                    
                </h4>
            </div>
           
            <!-- Pencarian -->
            <div class="uk-width-auto uk-flex uk-flex-middle"> 
                 <input class="form-check-input me-1" type="checkbox" id="autoScrollCheckbox">
                <label class="form-check-label uk-text-warning" for="autoScrollCheckbox">Auto Scroll</label>

                &nbsp;&nbsp;&nbsp;
                <input type="text" id="searchInput" class="uk-input uk-form-small uk-form-primary uk-form-width-small" placeholder="Cari Koin...">
            </div>
    </div>

    <div class="uk-overflow-auto uk-margin-small-top ">
        <table class="uk-table uk-table-hover uk-table-small uk-table-striped" style="border-collapse: collapse; width: 100%;">
            <thead style="background: #5c9514;">
                <tr style="border-bottom: 1px solid black;">
                    <th rowspan="2" class="uk-text-center uk-text-bolder" style=" color: white !important;">
                        ORDERBOOK
                    </th>
                    <th colspan="4" class="uk-text-center uk-text-bolder" style=" color: white !important;">
                        CEX ‚Üí DEX
                    </th>
                    <th rowspan="2" class="uk-text-center uk-text-bolder" style="color: white !important;">
                        DETAIL TOKEN
                    </th>
                    <th colspan="4" class="uk-text-center uk-text-bolder" style="color: white !important;">
                        DEX ‚Üí CEX
                    </th>
                    <th rowspan="2" class="uk-text-center uk-text-bolder" style="color: white !important;">
                        ORDERBOOK
                    </th>
                </tr>
            </thead>
            <tbody id="dataTableBody">
                <!-- Baris-baris data akan ditambahkan secara dinamis -->
            </tbody>
        </table>
        <!-- <div id="InfoAPP" style="text-align:center; font-weight:bold; color:red;">???</div>    
        <div id="InfoStatus" style="text-align:center; font-weight:bold; color:red;"></div>     -->
    </div>
    
      <!-- SECTION: TOKEN MANAGEMENT (LIST) -->
    <section id="token-management" style="display: none;" class="uk-card uk-card-default uk-card-hover uk-margin-small-top uk-padding-small">
        <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-small">
            <div class="uk-width-expand">
            <h4 class="uk-margin-remove uk-heading-line" id="judulmanajemenkoin">Manajemen KOIN</h4>
            </div>

            <div class="uk-flex uk-flex-middle" style="gap:6px;">
            <button id="btnNewToken" class="uk-button uk-button-primary uk-button-small">+ Add KOIN</button>
            <input id="searchMgr" class="uk-input uk-form-small uk-form-width-medium" placeholder="Cari koin...">
            </div>
        </div>

        <div class="uk-overflow-auto" style="max-height:100vh;">
            <table class="uk-table uk-table-striped uk-table-divider">
            <thead>
                <tr>
                <th style="width:46px">No</th>
                <th>Symbol Token / Pair</th>
                <th>Chain & Status</th>
                <th>Exchanger</th>
                <th>DEX & Modal [KIRI | KANAN]</th>
                <th style="width:130px">Action</th>
                </tr>
            </thead>
            <tbody id="mgrTbody"></tbody>
            </table>
        </div>
    </section>
  
</div>

<!-- Modal UIKIT SETTING -->
<div id="modal-setting" class="uk-modal-full" uk-modal>
<div class="uk-modal-dialog">
    <button class="uk-modal-close-full uk-close-large" type="button" uk-close></button>
    <div class="uk-modal-header">
    <h2 class="uk-modal-title">:: SETTING JEDA & SCANNER</h2>
    </div>
    <div class="uk-modal-body">
    <form>
        <div class="uk-grid-small" uk-grid>
        <div class="uk-width-1-2">
            <!-- Kolom pertama -->
            <div class="uk-card uk-card-default uk-card-body">
            <h3>JEDA CEX</h3>
            <div id="cex-checkbox-group"></div>  <!-- <-- container CEX input + checkbox -->

            <hr>

            <h3>JEDA DEX</h3>
            <div id="dex-checkbox-group"></div>  <!-- <-- container DEX input + checkbox -->
            </div>
        </div>
        <div class="uk-width-1-2">
            <!-- Kolom kedua -->
            <div class="uk-card uk-card-default uk-card-body">
            <h3 style="text-align: center; margin: 12px 0px; color: #1317e1;">:: SETINGAN SCANNER</h3>
            <label for="user">NICK NAME:</label>
            <input type="text" id="user" class="uk-input" required>

            <div class="uk-flex uk-flex-middle uk-margin">
                <div style="flex:1;">
                <label for="jeda-time-group" class="uk-text-danger">KOIN/GRUP :</label>
                <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="7" name="koin-group"> 7</label>
                <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="6" name="koin-group"> 6</label>
                <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="5" checked name="koin-group"> 5</label>
                <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="4" name="koin-group"> 4</label>
                </div>

                <div style="flex:1; margin-left: 24px;">
                <label for="speedScan" class="uk-text-danger">WAKTU TUNGGU:</label>
                <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="2" name="waktu-tunggu"> NORMAL</label>
                <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="1.5" name="waktu-tunggu"> MEDIUM</label>
                <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="1" name="waktu-tunggu"> FAST</label>
                </div>
            </div>
            <div>
                <label class="uk-text-warning">FILTER PNL</label><br/>
                <input class="uk-input" type="number" id="inFilterPNL" value="1" name="filterpnl" >         
            </div>

            <div class="uk-flex uk-flex-middle uk-margin">
                <div style="flex:1; margin-right: 8px;">
                <label for="jeda-time-group" class="uk-text-danger">JEDA / GROUP {1500}</label><br>
                <input class="uk-input" id="jeda-time-group" type="number" value="1500" name="jeda-time-group">
                </div>
                <div style="flex:1;">
                <label for="jeda-koin" class="uk-text-primary">JEDA / KOIN {500}</label><br>
                <input class="uk-input" type="number" id="jeda-koin" value="500" name="jeda-koin">
                </div>
            </div>

            <div>
                <label for="walletMeta" class="uk-text-danger">WALLET ADDRESS</label><br>
                <input class="uk-input" type="text" id="walletMeta" name="walletMeta">
            </div>

            <p class="uk-text-right uk-margin-top">
                <button class="uk-button uk-button-default uk-modal-close" type="button">Tutup</button>
                <button type="button" id="btn-save-setting" class="uk-button uk-button-primary">SIMPAN</button>
            </p>
            </div>
        </div>
        </div>
    </form>
    </div>
</div>
</div>
<!-- Modal UIKIT EDIT KOIN -->
 <div id="FormEditKoinModal" uk-modal>
    <div class="uk-modal-dialog uk-modal-body uk-padding-small">

        <!-- Header -->
        <div class="uk-flex uk-flex-middle uk-margin-small" id="judulmodal">
        <div class="uk-width-expand"></div>
        <div class="uk-text-center uk-width-auto">
            <h4 class="uk-modal-title uk-margin-remove">FORM Token & Pair</h4>
        </div>
        <div class="uk-width-expand uk-text-right">
            <button class="uk-modal-close-default" type="button" uk-close></button>
        </div>
        </div>

        <hr class="uk-margin-remove-top uk-margin-small-bottom">

        <!-- Info Detail Koin -->
        <form id="multiTokenForm" class="uk-form-stacked">
        <div class="uk-grid-small" uk-grid>
            <div class="uk-width-1-2@m">
            <label class="uk-form-label"><b>Nama Token & Desimal</b></label>
            <div class="uk-form-controls uk-grid-small" uk-grid>
                <div class="uk-width-expand">
                <input type="text" id="inputSymbolToken" class="uk-input uk-form-small" placeholder="Symbol Token">
                </div>
                <div class="uk-width-auto">
                <input type="number" id="inputDesToken" class="uk-input uk-form-small uk-form-width-small" placeholder="Desimal">
                </div>
            </div>
            <label class="uk-form-label uk-margin-small-top"><b>Smart Kontrak Token</b></label>
            <input type="text" id="inputSCToken" class="uk-input uk-form-small" placeholder="Smart Contract Token">
            </div>

            <div class="uk-width-1-2@m">
            <label class="uk-form-label"><b>Nama Pair & Desimal</b></label>
            <div class="uk-form-controls uk-grid-small" uk-grid>
                <div class="uk-width-expand">
                <input type="text" id="inputSymbolPair" class="uk-input uk-form-small" placeholder="Symbol Pair">
                </div>
                <div class="uk-width-auto">
                <input type="number" id="inputDesPair" class="uk-input uk-form-small uk-form-width-small" placeholder="Desimal">
                </div>
            </div>
            <label class="uk-form-label uk-margin-small-top"><b>Smart Kontrak Pair</b></label>
            <input type="text" id="inputSCPair" class="uk-input uk-form-small" placeholder="Smart Contract Pair">
            </div>
        </div>

<!-- Card: Chain, Status, CEX/DEX -->
      <div class="uk-card uk-card-default uk-card-small uk-card-body uk-margin-small-top">

        <!-- Chain & Status -->
        <div class="uk-grid-small" uk-grid>
          <div class="uk-width-1-1@m">
            <div class="uk-grid-small uk-child-width-1-3@m" uk-grid>
              <div>
                <label class="uk-form-label" for="mgrChain"><b>Chain</b></label>
                <select id="mgrChain" class="uk-select uk-form-small"></select>
              </div>

              <div>
                <label class="uk-form-label"><b>Status</b></label>
                <div class="uk-margin-small-top uk-flex uk-flex-middle" style="gap:12px;">
                <label class="uk-margin-remove">
                    <input class="uk-radio" type="radio" name="mgrStatus" id="mgrStatusOn"  value="on"  checked>
                    ON
                </label>
                <label class="uk-margin-remove">
                    <input class="uk-radio" type="radio" name="mgrStatus" id="mgrStatusOff" value="off">
                    OFF
                </label>
                </div>
            </div>

              <div><!-- spacer kolom ke-3 jika dibutuhkan --></div>
            </div>
          </div>
        </div>
    </div>
        
        <div class="uk-card uk-card-default uk-card-small uk-card-body uk-margin-small-top">
            
            <div class="uk-grid-small" uk-grid>
            <!-- Kolom CEX -->
            <div class="uk-width-1-3@m">
                <label class="uk-form-label uk-text-bold">Pilih CEX</label>
                <div id="cex-checkbox-koin" class="uk-margin-small-top"></div>
            </div>

            <!-- Kolom DEX -->
            <div class="uk-width-2-3@m">
                <label class="uk-form-label uk-text-bold">
                Pilih DEX (Maks 4) & Modal {KIRI, KANAN}
                </label>
                <div id="dex-checkbox-koin" class="uk-margin-small-top"></div>
            </div>
            </div>

            <input type="hidden" id="multiTokenIndex">
        </div>

        <!-- Tombol Action -->
        <div class="uk-flex uk-flex-right uk-margin-top uk-grid-small" uk-grid>
            <div><button class="uk-button uk-button-danger" type="button" id="HapusEditkoin">Hapus</button></div>
            <div><button class="uk-button uk-button-secondary uk-modal-close" type="button" id="BatalEditkoin">Batal</button></div>
            <div><button class="uk-button uk-button-primary" type="submit" id="SaveEditkoin">Simpan</button></div>
        </div>
        </form>

    </div>
</div>
    
<script>
   window.addEventListener('storage', function (event) {
    if (event.key !== 'MULTISCANNER_STATUS_RUN') return;
        const config = JSON.parse(event.newValue || '{}');
        const $start = $('#startSCAN');
        const $stop  = $('#stopSCAN');

        if (config.run === 'NO') {
            $start.prop('disabled', false).text('START').show();
            $stop.hide();
        } else if (config.run === 'YES') {
            $start.prop('disabled', true).text('Running...').show();
            $stop.prop('disabled', false).show();
        }
    });
    toastr.options = {
        "timeOut": "2500",            // Durasi munculnya toastr dalam milidetik
        "extendedTimeOut": "2000",    // Waktu tambahan saat toastr di-hover
        "closeButton": true,          // Tampilkan tombol close (opsional)
        "progressBar": true,          // Tampilkan progress bar (opsional)
        "positionClass": "toast-top-right" // Posisi toastr (ubah sesuai kebutuhan)
    };
    
    const storagePrefix = "MULTISCANNER_";
    
    // ====== GLOBAL HELPERS (de-duplicated) ======
    function createHoverLink(url, text, className = '') {
    return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="hover-link ${className}" title="${url}">${text}</a>`;
    }
    function safeUrl(u, fallback) {
    return (u && typeof u === 'string' && /^https?:\/\//i.test(u)) ? u : fallback;
    }
    function linkifyStatus(flag, label, urlOk, colorOk = 'green') {
    if (flag === true)  return `<a href="${urlOk}" target="_blank" class="uk-text-bold" style="color:${colorOk} !important;">${label}</a>`;
    if (flag === false) return `<span style="color:red; font-weight:bold;">${label === 'DP' ? 'DX' : 'WX'}</span>`;
    return `<span>${label.replace('P','-')}</span>`;
    }
    function getStatusLabel(flag, type) {
    if (flag === true)  return `<b style="color:green; font-weight:bold;">${type}</b>`;
    if (flag === false) return `<b style="color:red; font-weight:bold;">${type.replace('P','X')}</b>`;
    return `<b>${type.replace('P','-')}</b>`;
    }
    // ====== BOOT & READINESS GUARDS ======
    const REQUIRED_KEYS = {
        SETTINGS: 'SETTING_SCANNER',
        TOKENS: 'TOKEN_SCANNER'
    };

    function hasValidSettings() {
        const s = getFromLocalStorage(REQUIRED_KEYS.SETTINGS, {});
        return s && typeof s === 'object' && Object.keys(s).length > 0 && Array.isArray(s.AllChains) && s.AllChains.length > 0;
    }

    function hasValidTokens() {
        const t = getFromLocalStorage(REQUIRED_KEYS.TOKENS, []);
        return Array.isArray(t) && t.length > 0;
    }

    function computeAppReadiness() {
        const okS = hasValidSettings();
        const okT = hasValidTokens();
        if (okS && okT) return 'READY';
        if (!okS && !okT) return 'MISSING_BOTH';
        return okS ? 'MISSING_TOKENS' : 'MISSING_SETTINGS';
    }

    function applyControlsFor(state) {
        const $form   = $("#FormScanner");
        const $start  = $('#startSCAN');
        const $stop   = $('#stopSCAN');
        const $import = $('#uploadJSON');
        const $export = $('a[onclick="downloadTokenScannerCSV()"]');
        
        function setDisabled($els, disabled) {
            $els.prop('disabled', disabled)
                .css('opacity', disabled ? '0.5' : '')
                .css('pointer-events', disabled ? 'none' : '');
        }
        
        // lock everything by default
        setDisabled($form.find('input, select, button'), true);
        setDisabled($start.add($stop).add($export).add($import), true);
        
        if (state === 'READY') {
            setDisabled($form.find('input, select, button'), false);
            setDisabled($start.add($stop).add($export).add($import), false);
        } else if (state === 'MISSING_SETTINGS') {
            $('#infoAPP').html('‚ö†Ô∏è Lengkapi <b>SETTING</b> terlebih dahulu.').show();
            $('#SettingConfig').addClass('icon-wrapper');
        } else if (state === 'MISSING_TOKENS') {
            setDisabled($import, false);
            $('#infoAPP').html('‚ö†Ô∏è Import <b>DATA TOKEN</b> terlebih dahulu.').show();
        } else {
            $('#infoAPP').html('‚ö†Ô∏è Lengkapi <b>SETTING</b> & <b>DATA KOIN</b> terlebih dahulu.').show();
            $('#SettingConfig').addClass('icon-wrapper');
        }
    }

    function bootApp() {
        const state = computeAppReadiness();
        applyControlsFor(state);
        if (state === 'READY') {
            try { cekDataAwal(); } catch (e) { console.error('cekDataAwal error:', e); }
        } else {
            if (window.toastr) {
                if (state === 'MISSING_SETTINGS') toastr.warning('Lengkapi SETTING terlebih dahulu');
                else if (state === 'MISSING_TOKENS') toastr.warning('Import DATA TOKEN terlebih dahulu');
                else toastr.warning('Lengkapi SETTING & TOKEN');
            }
        }
    }

    document.addEventListener('DOMContentLoaded', bootApp);
    let sortOrder = {};
    const stablecoins = ["USDT", "DAI", "USDC", "FDUSD"];
       
    var SavedSettingData = getFromLocalStorage('SETTING_SCANNER', {});
    var DataTokens = getFromLocalStorage('TOKEN_SCANNER',[]);
  
    let filteredTokens = [];
    let originalTokens = [];

    // Get managed chains from settings
    function getManagedChains() {
        const settings = getFromLocalStorage('SETTING_SCANNER', {});
        return settings.AllChains || Object.keys(CONFIG_CHAINS);
    }

    // Fungsi untuk mendapatkan data chain berdasarkan nama chain
    function getChainData(chainName) {
        if (!chainName) return null;
        
        const chainLower = chainName.toLowerCase();
        const chainData = CONFIG_CHAINS[chainLower];
        
        const managedChains = getManagedChains();
        if (!managedChains.includes(chainLower)) {
            console.log(`Chain ${chainName} tidak termasuk dalam chain yang dikelola`);
            return null;
        }
        
        if (!chainData) {
            console.log(`Chain dengan nama ${chainName} tidak ditemukan di CONFIG_CHAINS`);
            return null;
        }

        return {
            Kode_Chain: chainData.Kode_Chain || '',
            Nama_Chain: chainData.Nama_Chain || '',
            DEXS: chainData.DEXS || {},
            PAIRDExS: chainData.PAIRDExS || {},
            URL_Chain: chainData.URL_Chain || '', 
            DATAJSON: chainData.DATAJSON || {},
            BaseFEEDEX: chainData.BaseFEEDEX || '',
            CEXCHAIN: chainData.WALLET_CEX || {},
            ICON_CHAIN: chainData.ICON || '',
            COLOR_CHAIN: chainData.WARNA || '#000',
            SHORT_NAME: chainData.Nama_Pendek || '',
            RPC: chainData.RPC || '' // ‚¨Ö penting
        };
    }

    function getCexDataConfig(cexName) {
        if (!cexName || typeof cexName !== 'string') return null;

        const key = cexName.toUpperCase();
        const cexData = (typeof CONFIG_CEX === 'object' && CONFIG_CEX[key]) ? CONFIG_CEX[key] : null;

        if (!cexData) {
            console.log(`CEX dengan nama ${cexName} tidak ditemukan di CONFIG_CEX`);
            return null;
        }

        return {
            NAME: key,
            API_KEY: cexData.ApiKey || '',
            API_SECRET: cexData.ApiSecret || '',
            COLOR: cexData.WARNA || '#000'
        };
    }

    function getDexData(dexName) {
        if (!dexName || typeof dexName !== 'string') return null;

        // Normalisasi key sesuai definisi di CONFIG_DEXS
        const nameLower = dexName.toLowerCase();
        let dexKey = nameLower;
        // Beberapa key di CONFIG_DEXS menggunakan format khusus ("0x", "1inch")
        if (nameLower === '0x') dexKey = '0x';
        if (nameLower === '1inch') dexKey = '1inch';

        const dexBuilder = (typeof CONFIG_DEXS === 'object') ? CONFIG_DEXS[dexKey] : undefined;

        if (!dexBuilder) {
            console.log(`DEX dengan nama ${dexName} tidak ditemukan di CONFIG_DEXS`);
            return null;
        }

        // Kumpulkan daftar chain yang mendukung DEX ini (berdasarkan CONFIG_CHAINS[*].DEXS)
        const supportedChains = Object.keys(CONFIG_CHAINS || {})
            .filter(chain => Array.isArray(CONFIG_CHAINS[chain].DEXS) && CONFIG_CHAINS[chain].DEXS.map(String).map(s=>s.toLowerCase()).includes(dexKey))
            .map(chain => ({
                key: chain,                                      // key object di CONFIG_CHAINS
                code: CONFIG_CHAINS[chain].Kode_Chain || '',     // kode chain (angka)
                name: CONFIG_CHAINS[chain].Nama_Chain || chain,  // nama chain (string)
                short: CONFIG_CHAINS[chain].Nama_Pendek || '',
                color: CONFIG_CHAINS[chain].WARNA || '#000'
            }));

        return {
            NAME: dexKey,                        // nama dex ter-normalisasi
            HAS_BUILDER: typeof dexBuilder === 'function',
            BUILDER: dexBuilder || null,         // fungsi pembentuk URL (bila ada)
            SUPPORTED_CHAINS: supportedChains    // daftar chain yang mendukung DEX ini
        };
    }

function refreshTokensTable() {
    // Ambil daftar chain yang diizinkan dari setting
    const settingScanner = getFromLocalStorage('SETTING_SCANNER', {});
    const allowedChains = (settingScanner.AllChains || []).map(c => c.toLowerCase());

    // Ambil data mentah dari localStorage
    const allTokens = getFromLocalStorage("TOKEN_SCANNER", []);

    // Flatten data agar struktur konsisten
    const flatTokens = flattenDataKoin(allTokens);

    // Filter sesuai AllChains dan sorting A-Z berdasarkan symbol_in (SAMA SEPERTI cekDataAwal)
    const filteredByChain = flatTokens
        .filter(token =>
            allowedChains.includes((token.chain || '').toLowerCase())
        )
        .sort((a, b) => {
            const A = (a.symbol_in || '').toUpperCase();
            const B = (b.symbol_in || '').toUpperCase();
            if (A < B) return -1; // A-Z
            if (A > B) return  1; // A-Z
            return 0;
        });

    filteredTokens = [...filteredByChain];
    originalTokens = [...filteredByChain];

    updateTokenCount();
    loadKointoTable(filteredTokens);
    
    const uniqueKeys = new Set();
    filteredTokens.forEach(item => {
        // buat key unik (cex|chain|symbol_in|symbol_out)
        const key = `${item.cex}|${item.chain}|${item.symbol_in}|${item.symbol_out}`;
        uniqueKeys.add(key);
    });

    $('#tokenCountALL').text(`TOTAL SEMUA: ${uniqueKeys.size} PAIR-TOKEN`);
}

function loadKointoTable(filteredData) {
        loadSignalData();
        const $tableBody = $('#dataTableBody');
        $tableBody.empty();

        if (!Array.isArray(filteredData) || filteredData.length === 0) {
            $('#startSCAN').prop('disabled', true);
            return;
        }

        const fragment = document.createDocumentFragment();
        const maxSlots = 4;
       
        filteredData.forEach((data, index) => {
            const row = document.createElement('tr');

            /** ========== ORDERBOOK kiri (CEX) ========== **/
            const tdOrderbookLeft = document.createElement('td');
            tdOrderbookLeft.textContent = data.cex;
            const warnaCex = (CONFIG_CEX[data.cex] && CONFIG_CEX[data.cex].WARNA) || '#000';
            tdOrderbookLeft.style.color = warnaCex;
            tdOrderbookLeft.style.textAlign = 'center';
            tdOrderbookLeft.style.verticalAlign = 'middle';
            tdOrderbookLeft.innerHTML = `
                    <span id="LEFT_${data.cex}_${data.symbol_in}_${data.symbol_out}_${data.chain.toUpperCase()}">
                        <b>PRICE & VOL BUY <br>${data.cex}</b> üîí
                    </span>
                `;
            row.appendChild(tdOrderbookLeft);

        /** ========== CEX ‚Üí DEX (Kiri) ========== **/
            for (let i = 0; i < maxSlots; i++) {
                const td = document.createElement('td');
                td.style.textAlign = 'center';
                td.style.verticalAlign = 'middle';
                if (data.dexs && data.dexs[i]) {
                    const dexName = data.dexs[i].dex || '-';
                    const modalLeft = data.dexs[i].left ?? 0;
                    const idCELL = `${data.cex.toUpperCase()}_${dexName.toUpperCase()}_${data.symbol_in}_${data.symbol_out}_${(data.chain).toUpperCase()}`;
                    td.id=idCELL;

                   let innerHTML = `
                        <strong class="uk-align-center" style="display:inline-block; margin:0;">${dexName.toUpperCase()} [$${modalLeft}]</strong><br>
                        <span class="buy" id="BUY_${idCELL}" title="BUY_${idCELL}"></span><br>
                        <span class="uk-text-primary uk-text-bolder" id="SWAP_${idCELL}"> üîí </span><br>
                        <span class="sell" id="SELL_${idCELL}" title="SELL_${idCELL}"></span><br>
                        <hr class="uk-divider-small uk-margin-remove">
                        <span class="uk-text-primary" id="RESULT_${idCELL}"></span>
                    `;

                    td.innerHTML = innerHTML;
                } else {
                    td.style.backgroundColor="#b2aeae";
                    td.textContent = '-';
                }
                row.appendChild(td);
            }

            /** ========== DETAIL INFO ========== **/
            const chainLower = data.chain?.toLowerCase();
            const chainConfig = CONFIG_CHAINS[chainLower] || { URL_Chain: '', WARNA: '#000', Kode_Chain: '', Nama_Chain: '' };
            const warnaChain = chainConfig.WARNA || '#000';
            const urlScIn = chainConfig.URL_Chain ? `${chainConfig.URL_Chain}/token/${data.sc_in}` : '#';
            const urlScOut = chainConfig.URL_Chain ? `${chainConfig.URL_Chain}/token/${data.sc_out}` : '#';
            const urlsCEX = GeturlExchanger(data.cex, data.symbol_in, data.symbol_out);

            // Trade pages (prefer CEX trade links; fallback to explorer token page)
            const tradeTokenUrl = safeUrl(urlsCEX?.tradeToken, urlScIn);
            const tradePairUrl  = safeUrl(urlsCEX?.tradePair,  urlScOut);

            // Deposit/Withdraw pages (prefer specific token/pair URLs; fallback to generic withdraw/deposit or explorer)
            const withdrawTokenUrl = safeUrl(urlsCEX?.withdrawTokenUrl || urlsCEX?.withdrawUrl, urlScIn);
            const depositTokenUrl  = safeUrl(urlsCEX?.depositTokenUrl  || urlsCEX?.depositUrl,  urlScIn);
            const withdrawPairUrl  = safeUrl(urlsCEX?.withdrawPairUrl  || urlsCEX?.withdrawUrl, urlScOut);
            const depositPairUrl   = safeUrl(urlsCEX?.depositPairUrl   || urlsCEX?.depositUrl,  urlScOut);

            // Link builder for symbols (always clickable)
            const linkToken = createHoverLink(tradeTokenUrl, (data.symbol_in||'').toUpperCase());
            const linkPair  = createHoverLink(tradePairUrl,  (data.symbol_out||'').toUpperCase());

            const WD_TOKEN = linkifyStatus(data.withdrawToken, 'WD', withdrawTokenUrl);
            const DP_TOKEN = linkifyStatus(data.depositToken,  'DP', depositTokenUrl);
            const WD_PAIR  = linkifyStatus(data.withdrawPair,  'WD', withdrawPairUrl);
            const DP_PAIR  = linkifyStatus(data.depositPair,   'DP', depositPairUrl);

            // üîπ Token
            const depositToken = getStatusLabel(data.depositToken, 'DP');
            const withdrawToken = getStatusLabel(data.withdrawToken, 'WD');

            // üîπ Pair
            const depositPair = getStatusLabel(data.depositPair, 'DP');
            const withdrawPair = getStatusLabel(data.withdrawPair, 'WD');

            const chainData = getChainData(data.chain);
            const walletObj = chainData?.CEXCHAIN?.[data.cex] || {};
            const linkStokToken = Object.entries(walletObj)
                .filter(([key, val]) => key.toLowerCase().includes('address') && val && val !== '#')
                .map(([key, val], idx) => createHoverLink(`${chainConfig.URL_Chain}/token/${data.sc_in}?a=${val}`, `#${idx + 1} `))
                .join('');
            const linkStokPair = Object.entries(walletObj)
                .filter(([key, val]) => key.toLowerCase().includes('address') && val && val !== '#')
                .map(([key, val], idx) => createHoverLink(`${chainConfig.URL_Chain}/token/${data.sc_out}?a=${val}`, `#${idx + 1} `))
                .join('');

            // const linkToken = createHoverLink(urlsCEX.tradeToken, data.symbol_in.toUpperCase());
            // const linkPair = createHoverLink(urlsCEX.tradePair, data.symbol_out.toUpperCase());
            const linkSCtoken = createHoverLink(urlScIn, '[SC]', 'uk-text-primary');
            const linkSCpair = createHoverLink(urlScOut, '[SC]', 'uk-text-primary');

            const linkOKDEX = createHoverLink(`https://www.okx.com/web3/dex-swap?inputChain=${chainConfig.Kode_Chain}&inputCurrency=${data.sc_in}&outputChain=501&outputCurrency=${data.sc_out}`, '#OKX', 'uk-text-secondary');
            const linkUNIDEX = createHoverLink(`https://app.unidex.exchange/?chain=${chainConfig.Nama_Chain}&from=${data.sc_in}&to=${data.sc_out}`, '#UND', 'uk-text-success');
            const linkDEFIL = createHoverLink(`https://swap.defillama.com/?chain=${chainConfig.Nama_Chain}&from=${data.sc_in}&to=${data.sc_out}`, '#DFL', 'uk-text-primary');
            const linkLiFi = createHoverLink(`https://jumper.exchange/?fromChain=${chainConfig.Kode_Chain}&fromToken=${data.sc_in}&toChain=${chainConfig.Kode_Chain}&toToken==${data.sc_out}`, '#LFX', 'uk-text-warning');

            const tdDetail = document.createElement('td');
            const rowId = `DETAIL_${String(data.cex).toUpperCase()}_${String(data.symbol_in).toUpperCase()}_${String(data.symbol_out).toUpperCase()}_${String(data.chain).toUpperCase()}`.replace(/[^A-Z0-9_]/g,'');
            tdDetail.id = rowId;
            tdDetail.className = 'uk-text-center uk-background uk-text-nowrap';
            tdDetail.style.textAlign = 'center';
            tdDetail.style.border='1px solid black';
            const chainShort = (data.chain || '').substring(0,3).toUpperCase();
            tdDetail.innerHTML = `
                [${index + 1}] <span style="color: ${warnaCex}; font-weight:bolder;">${data.cex} </span> 
                on <span style="color: ${warnaChain}; font-weight:bolder;">${chainShort} </span><br/>
                 <span style="color: ${warnaChain}; font-weight:bolder;">${linkToken} </span> 
                 ‚áÑ <span style="color: ${warnaChain}; font-weight:bolder;">${linkPair} </span>
                <span id="EditMulti-${data.id}"  
                    data-id="${data.id}" 
                    data-cex="${data.cex}" 
                    data-coin="${data.symbol_in}"  
                    title="UBAH DATA KOIN" 
                    uk-icon="icon: pencil; ratio: 0.6"   
                    class="uk-text-secondary uk-text-bolder"  
                    style="cursor:pointer"></span> </br>
                <span class="uk-text-bolder">${WD_TOKEN} ~ ${DP_TOKEN}</span> | 
                <span class="uk-text-bolder">${WD_PAIR} ~ ${DP_PAIR}</span><br/>
                <span class="uk-text-primary uk-text-bolder">${(data.symbol_in||'').toUpperCase()}</span> ${linkSCtoken} : ${linkStokToken} <br/>
                <span class="uk-text-primary uk-text-bolder">${(data.symbol_out||'').toUpperCase()}</span> ${linkSCpair} : ${linkStokPair}<br/>
                 ${linkUNIDEX} ${linkOKDEX} ${linkDEFIL} ${linkLiFi}
            `;
            row.appendChild(tdDetail);


        /** ========== DEX ‚Üí CEX (Kanan) ========== **/
            for (let i = 0; i < maxSlots; i++) {
                const td = document.createElement('td');
                td.style.textAlign = 'center';
                td.style.verticalAlign = 'middle';
                if (data.dexs && data.dexs[i]) {
                    const dexName = data.dexs[i].dex || '-';
                    const modalRight = data.dexs[i].right ?? 0;
                    const idCELL = `${data.cex}_${dexName.toUpperCase()}_${data.symbol_out}_${data.symbol_in}_${data.chain.toUpperCase()}`;
                    td.id = idCELL;

                   let innerHTML = `
                        <strong class="uk-align-center" style="display:inline-block; margin:0; padding:0;">${dexName.toUpperCase()} [$${modalRight}]</strong><br>
                        <span class="buy" id="BUY_${idCELL}" title="BUY_${idCELL}"> </span><br>
                        <span class="uk-text-primary uk-text-bolder" id="SWAP_${idCELL}"> üîí </span><br>
                        <span class="sell" id="SELL_${idCELL}" title="SELL_${idCELL}"> </span><br>
                        <hr class="uk-divider-small uk-margin-remove">
                        <span class="uk-text-primary" id="RESULT_${idCELL}"> </span>
                    `;

                    td.innerHTML = innerHTML;
                } else {
                    td.style.backgroundColor="#b2aeae";
                    td.textContent = '-';
                }
                row.appendChild(td);
            }


            /** ========== ORDERBOOK kanan (CEX) ========== **/
            const tdOrderbookRight = document.createElement('td');
            tdOrderbookRight.textContent = data.cex;
            tdOrderbookRight.style.color = warnaCex;
            tdOrderbookRight.style.textAlign = 'center';
            tdOrderbookRight.style.verticalAlign = 'middle';
            tdOrderbookRight.innerHTML = `
                    <span id="RIGHT_${data.cex}_${data.symbol_in}_${data.symbol_out}_${data.chain.toUpperCase()}">
                       <b> PRICE & VOL SELL <br>${data.cex}</b> üîí
                    </span>
                `;
            row.appendChild(tdOrderbookRight);

            fragment.appendChild(row);
        });

        $tableBody.append(fragment);
    }

    // ==========================
    // EDIT KOIN: OPEN & POPULATE
    // ==========================
    $(document).on('click', '[id^="EditMulti-"]', function () {
        try {
            const id = $(this).data('id');
            if (!id) {
                toastr.error('ID token tidak ditemukan');
                return;
            }
            openEditModalById(id);
        } catch (e) {
            console.error('Gagal membuka modal edit:', e);
            toastr.error('Gagal membuka form edit');
        }
    });

   function getChainOptions() {
  const cfg = window.CONFIG_CHAINS || {};
  return Object.keys(cfg)
    .map(k => {
      const item = cfg[k] || {};
      return {
        key: String(k).toLowerCase(),
        label: (item.Nama_Chain || k).toUpperCase()
      };
    });
}

// Ambil SEMUA chain dari CONFIG_CHAINS lalu isi <select>
function populateChainSelect($select, selectedKey) {
  const cfg = window.CONFIG_CHAINS || {};
  const keys = Object.keys(cfg);

  // Jika config belum siap, tampilkan placeholder agar kelihatan penyebabnya
  $select.empty();
  if (!keys.length) {
    $select.append('<option value="">-- PILIHAN CHAIN --</option>');
    return;
  }

  // Render opsi
  keys.sort().forEach(k => {
    const item  = cfg[k] || {};
    const label = (item.Nama_Chain || item.nama_chain || item.name || k).toString().toUpperCase();
    $select.append(`<option value="${k.toLowerCase()}">${label}</option>`);
  });

  // Select nilai yang diinginkan bila ada; jika tidak, pilih pertama
  const want = String(selectedKey || '').toLowerCase();
  const lowerKeys = keys.map(k => k.toLowerCase());
  $select.val(lowerKeys.includes(want) ? want : lowerKeys[0]);
}


    function setStatusRadios(isOn) {
    $('#mgrStatusOn').prop('checked', !!isOn);
    $('#mgrStatusOff').prop('checked', !isOn);
    }

    function readStatusRadio() {
    return ($('input[name="mgrStatus"]:checked').val() === 'on'); // true = ON, false = OFF
    }

    function openEditModalById(id) {
        // Ambil semua token dari localStorage
        const tokens = getFromLocalStorage('TOKEN_SCANNER', []);
        const token = (Array.isArray(tokens) ? tokens : []).find(t => String(t.id) === String(id));

        if (!token) {
            toastr.error('Data token tidak ditemukan');
            return;
        }

        // 1) Isi field dasar
        
        $('#multiTokenIndex').val(token.id);
        $('#inputSymbolToken').val(token.symbol_in || '');
        $('#inputDesToken').val(token.des_in ?? '');
        $('#inputSCToken').val(token.sc_in || '');

        $('#inputSymbolPair').val(token.symbol_out || '');
        $('#inputDesPair').val(token.des_out ?? '');
        $('#inputSCPair').val(token.sc_out || '');

        setStatusRadios(!!token.status);

        const $ctx = $('#FormEditKoinModal');
        const $sel = $ctx.find('#mgrChain');
        populateChainSelect($sel, token.chain);    
        // 2) Bangun ulang checkbox CEX & DEX khusus form edit
        try {
            buildCexCheckboxForKoin(token);
        } catch (e) { console.warn('Build CEX gagal:', e); }

        try {
            buildDexCheckboxForKoin(token);
        } catch (e) { console.warn('Build DEX gagal:', e); }

        $sel.off('change.rebuildDex').on('change.rebuildDex', function(){
    const newChain = $(this).val();
    try { buildDexCheckboxForKoin({ ...token, chain: newChain }); } catch (_) {}
  });
        // 3) Tampilkan modal
        if (window.UIkit && UIkit.modal) {
            UIkit.modal('#FormEditKoinModal').show();
        } else {
            // fallback jika UIkit belum siap
            document.getElementById('FormEditKoinModal').style.display = 'block';
        }
    }

    // ==========================
    // Helpers: Generate CEX checkboxes di modal edit
    // ==========================
    function buildCexCheckboxForKoin(token) {
        const container = $('#cex-checkbox-koin');
        container.empty();

        const selected = (token.selectedCexs || []).map(s => String(s).toUpperCase());

        // CONFIG_CEX: render semua CEX yang tersedia
        Object.keys(CONFIG_CEX || {}).forEach(cexKey => {
            const upper = String(cexKey).toUpperCase();
            const isChecked = selected.includes(upper);
            const color = (CONFIG_CEX[upper] && CONFIG_CEX[upper].WARNA) || '#000';
            const id = `cex-${upper}`;
            const html = `
                <label class="uk-display-block uk-margin-xsmall">
                    <input type="checkbox" class="uk-checkbox" id="${id}" value="${upper}" ${isChecked ? 'checked' : ''}>
                    <span style="color:${color}; font-weight:bold;">${upper}</span>
                </label>
            `;
            container.append(html);
        });
    }

    // ==========================
    // Helpers: Generate DEX checkboxes + input modal kiri/kanan
    // ==========================
    function buildDexCheckboxForKoin(token = {}) {
        const container = $('#dex-checkbox-koin');
        container.empty();

        const chainName = token.chain || '';
        // ‚ö†Ô∏è ambil langsung dari CONFIG_CHAINS agar tidak terblokir setting
        const chainCfg = CONFIG_CHAINS?.[String(chainName).toLowerCase()] || CONFIG_CHAINS?.[chainName] || {};
        const allowedDexs = Array.isArray(chainCfg.DEXS)
            ? chainCfg.DEXS
            : Object.keys(chainCfg.DEXS || {});

        if (!allowedDexs.length) {
            container.html('<div class="uk-text-meta">Tidak ada DEX terdefinisi untuk chain ini di CONFIG_CHAINS.</div>');
            return;
        }

        const selectedDexs = (token.selectedDexs || []).map(d => String(d).toLowerCase());
        const dataDexs = token.dataDexs || {}; // { DEX: { left, right } }

        allowedDexs.forEach(dexNameRaw => {
            const dexName = String(dexNameRaw);
            const dexKeyLower = dexName.toLowerCase();
            const isChecked = selectedDexs.includes(dexKeyLower) || selectedDexs.includes(dexName);

            const stored = dataDexs[dexName] || dataDexs[dexKeyLower] || {};
            const leftVal  = stored.left  ?? 0;
            const rightVal = stored.right ?? 0;

            const safeId = dexKeyLower.replace(/[^a-z0-9_-]/gi, '');
            const chkId = `dex-${safeId}`;
            const leftId = `dex-${safeId}-left`;
            const rightId = `dex-${safeId}-right`;

            const html = `
            <div class="uk-flex uk-flex-middle uk-margin-small">
                <label class="uk-margin-small-right">
                <input type="checkbox" class="uk-checkbox dex-edit-checkbox" id="${chkId}" value="${dexName}" ${isChecked ? 'checked' : ''}>
                <b>${dexName.toUpperCase()}</b>
                </label>
                <div class="uk-flex uk-flex-middle" style="gap:6px;">
                <input type="number" class="uk-input uk-form-xxsmall dex-left"  id="${leftId}"  placeholder="KIRI"  value="${leftVal}"  style="width:88px;">
                <input type="number" class="uk-input uk-form-xxsmall dex-right" id="${rightId}" placeholder="KANAN" value="${rightVal}" style="width:88px;">
                </div>
            </div>
            `;
            container.append(html);
        });

        // Batasi maksimal 4 DEX tercentang
        container.off('change.max4').on('change.max4', '.dex-edit-checkbox', function(){
            if (container.find('.dex-edit-checkbox:checked').length > 4) {
            this.checked = false;
            toastr.warning('Maksimal 4 DEX dipilih');
            }
        });
    }

    // ==========================
    // SAVE EDIT KOIN (Submit Form)
    // ==========================
    $(document).on('submit', '#multiTokenForm', function (e) {
        e.preventDefault();

        const id = $('#multiTokenIndex').val();
        if (!id) {
            toastr.error('ID token tidak ditemukan.');
            return;
        }

        // --- Baca field dasar
        const symbol_in  = ($('#inputSymbolToken').val() || '').toString().trim();
        const des_in     = Number($('#inputDesToken').val() || 0);
        const sc_in      = ($('#inputSCToken').val() || '').toString().trim();
        const status = readStatusRadio();
        const symbol_out = ($('#inputSymbolPair').val() || '').toString().trim();
        const des_out    = Number($('#inputDesPair').val() || 0);
        const sc_out     = ($('#inputSCPair').val() || '').toString().trim();
        const chain = String($('#FormEditKoinModal #mgrChain').val() || '').toLowerCase();
        // --- Ambil CEX & DEX yang dipilih dari form
        const { selectedCexs } = readCexSelectionFromForm();
        const { selectedDexs, dataDexs } = readDexSelectionFromForm();

        // Validasi ringan
        if (!symbol_in || !symbol_out) {
            toastr.warning('Symbol Token & Pair tidak boleh kosong');
            return;
        }

        if (selectedDexs.length > 4) {
            toastr.warning('Maksimal 4 DEX yang dipilih');
            return;
        }
        // --- Upsert ke TOKEN_SCANNER (ADD jika belum ada, EDIT jika sudah ada) ---
        let tokens = getFromLocalStorage('TOKEN_SCANNER', []);
        if (!Array.isArray(tokens)) tokens = [];

        // Cari apakah ID sudah ada (EDIT) atau belum ada (ADD)
        const idx = tokens.findIndex(t => String(t.id) === String(id));
        const isEdit = idx !== -1;

        // Siapkan struktur dataCexs hanya untuk CEX terpilih
        const buildDataCexs = (prev = {}) => {
            const obj = {};
            (selectedCexs || []).forEach(cx => {
                const up = String(cx).toUpperCase();
                const old = prev[up] || {};
                obj[up] = {
                    feeWDToken: parseFloat(old.feeWDToken) || 0,
                    feeWDPair: parseFloat(old.feeWDPair) || 0,
                    depositToken: !!old.depositToken,
                    withdrawToken: !!old.withdrawToken,
                    depositPair: !!old.depositPair,
                    withdrawPair: !!old.withdrawPair
                };
            });
            return obj;
        };

        if (isEdit) {
            // === EDIT ===
            const old = tokens[idx] || {};
            tokens[idx] = {
                ...old,
                symbol_in,
                des_in,
                sc_in,
                symbol_out,
                des_out,
                sc_out,
                chain,
                status,
                selectedCexs,                 // array of uppercase CEX
                selectedDexs,                 // array of dex names
                dataDexs,                     // { DEX: {left,right} }
                dataCexs: buildDataCexs(old.dataCexs || {})
            };
        } else {
            // === ADD ===
            const newId = Date.now().toString();
            $('#multiTokenIndex').val(newId); // simpan ke form agar konsisten

            // Default dataCexs untuk CEX terpilih (biarkan semua flag false & fee 0; user bisa edit nanti)
            const dataCexs = buildDataCexs({});

            const newToken = {
                id: newId,
                status: !!status,
                chain,
                // token & pair
                symbol_in,
                des_in,
                sc_in,
                symbol_out,
                des_out,
                sc_out,
                // relasi
                selectedCexs,
                selectedDexs,
                dataDexs,    // { DEX: {left,right} }
                dataCexs     // { CEX: {feeWDToken, feeWDPair, depositToken, withdrawToken, depositPair, withdrawPair} }
            };
            tokens.push(newToken);
        }

        saveToLocalStorage('TOKEN_SCANNER', tokens);
        if (isEdit) {
            toastr.success('Perubahan token berhasil disimpan');
        } else {
            toastr.success('Token baru berhasil ditambahkan');
        }
        refreshTokensTable();
        setLastAction(isEdit ? "UBAH DATA KOIN" : "TAMBAH DATA KOIN");
        if (window.UIkit && UIkit.modal) UIkit.modal('#FormEditKoinModal').hide();
    });

    // ==========================
    // Helpers: baca pilihan CEX dari form edit
    // ==========================
    function readCexSelectionFromForm() {
        const selectedCexs = [];
        $('#cex-checkbox-koin input[type="checkbox"]').each(function () {
            if (this.checked) selectedCexs.push(String($(this).val()).toUpperCase());
        });
        return { selectedCexs };
    }

    // ==========================
    // Helpers: baca pilihan DEX + modal kiri/kanan dari form edit
    // ==========================
    function readDexSelectionFromForm() {
        const selectedDexs = [];
        const dataDexs = {}; // { dexName: { left, right } }

        $('#dex-checkbox-koin .dex-edit-checkbox').each(function () {
            const dexName = String($(this).val());
            const dexKeyLower = dexName.toLowerCase().replace(/[^a-z0-9_-]/gi, '');
            const leftId  = `#dex-${dexKeyLower}-left`;
            const rightId = `#dex-${dexKeyLower}-right`;

            // Ambil nilai modal; default 0 jika bukan angka
            const leftVal  = parseFloat($(leftId).val());
            const rightVal = parseFloat($(rightId).val());
            const l = isNaN(leftVal)  ? 0 : leftVal;
            const r = isNaN(rightVal) ? 0 : rightVal;

            if (this.checked) {
                selectedDexs.push(dexName);
                dataDexs[dexName] = { left: l, right: r };
            }
        });

        return { selectedDexs, dataDexs };
    }

    // ==========================
    // Tombol Hapus (by ID saja) ‚Äî pastikan ini ada, jika belum sudah disediakan sebelumnya
    // ==========================
    $(document).on('click', '#HapusEditkoin', function (e) {
        e.preventDefault();

        const id    = $('#multiTokenIndex').val();
        const token = ($('#inputSymbolToken').val() || '').toString();
        const pair  = ($('#inputSymbolPair').val()  || '').toString();

        if (!id) { toastr.error('ID token tidak ditemukan.'); return; }

        // Ambil info CEX untuk ditampilkan pada konfirmasi
        let cexListShow = '';
        try {
            const all = getFromLocalStorage('TOKEN_SCANNER', []);
            const t   = (Array.isArray(all) ? all : []).find(x => String(x.id) === String(id)) || {};
            const persistedCexs = Array.isArray(t.selectedCexs) ? t.selectedCexs : [];

            // Jika user sudah mengubah checkbox di form tapi belum simpan, tampilkan kondisi form sebagai fallback
            let formCexs = [];
            $('#cex-checkbox-koin input[type="checkbox"]').each(function(){ if (this.checked) formCexs.push(String($(this).val()).toUpperCase()); });

            const finalCexs = (persistedCexs.length ? persistedCexs : formCexs);
            cexListShow = finalCexs.length ? `${finalCexs.join(', ')} (${finalCexs.length} CEX)` : '‚Äî';
        } catch (e1) {
            cexListShow = '‚Äî';
        }

        const msg = [
            `‚ö†Ô∏è INGIN HAPUS DATA KOIN ${token.toUpperCase() || '[TOKEN]'} VS ${pair.toUpperCase() || '[PAIR]'}?`,
            `CEX TERKAIT: ${cexListShow}`
        ].join("\n");

        if (confirm(msg)) {
            deleteTokenById(id);
            toastr.success(`KOIN ${token.toUpperCase() || ''} ${token && pair ? 'VS ' : ''}${pair.toUpperCase() || ''} TERHAPUS`);
            if (window.UIkit && UIkit.modal) UIkit.modal('#FormEditKoinModal').hide();
            
        }
    });

    function deleteTokenById(tokenId) {
        let tokens = getFromLocalStorage('TOKEN_SCANNER', []);
        if (!Array.isArray(tokens)) tokens = [];
        const updated = tokens.filter(t => String(t.id) !== String(tokenId));
        saveToLocalStorage('TOKEN_SCANNER', updated);
        refreshTokensTable();
        setLastAction("HAPUS KOIN");
    }

    function updateTokenCount() {
        $("#tokenCount").text(`(${filteredTokens.length})`);
      //  console.warn("Tokens data", filteredTokens);
    }

    function updateDarkIcon(isDark) {
        const icon = document.querySelector('#darkModeToggle span');
        if (icon) {
            icon.setAttribute("uk-icon", isDark ? "icon: sun; ratio: 1.4" : "icon: moon; ratio: 1.4");
            UIkit.icon(icon).$emit('update'); // refresh ikon
        }
    }
   
    function convertIDRtoUSDT(idrAmount) {
        const rateUSDT = getFromLocalStorage("PRICE_RATE_USDT", 0);
        if (!rateUSDT || rateUSDT === 0) return 0;
        return parseFloat((idrAmount / rateUSDT).toFixed(8));
    }

    async function feeGasGwei() {
        const settingScanner = getFromLocalStorage('SETTING_SCANNER', {});
        const allChains = settingScanner.AllChains || [];
        const Web3 = window.Web3;

        if (!allChains.length) {
            console.warn("Tidak ada chain yang dipilih di SETTING_SCANNER.AllChains");
            return;
        }

        // üîç Ambil semua data chain dari config
        const chainInfos = allChains
            .map(name => {
                const chainData = getChainData(name);
                if (!chainData || !chainData.BaseFEEDEX || !chainData.RPC) return null;

                return {
                    ...chainData,
                    rpc: chainData.RPC,
                    symbol: chainData.BaseFEEDEX.replace("USDT", ""),
                    gasLimit: chainData.gasLimit || 21000
                };
            })
            .filter(c => c && c.rpc && c.symbol);

        const uniqueSymbols = [...new Set(chainInfos.map(c => c.BaseFEEDEX.toUpperCase()))];
        if (!uniqueSymbols.length) {
            console.warn("Tidak ada simbol token gas yang valid untuk Binance API");
            return;
        }

        // üîó Ambil harga token gas dari Binance
        let tokenPrices = {};
        try {
            const binanceURL = `https://api-gcp.binance.com/api/v3/ticker/price?symbols=${encodeURIComponent(JSON.stringify(uniqueSymbols))}`;
            const response = await $.getJSON(binanceURL);
            response.forEach(item => {
                const symbol = item.symbol.replace('USDT', '');
                tokenPrices[symbol] = parseFloat(item.price);
            });
        } catch (err) {
            console.error("Gagal ambil harga token gas dari Binance:", err);
            return;
        }

        // üì¶ Array untuk menyimpan semua hasil
        const gasResults = [];

        // üî• Hitung gas fee per chain
        for (const chainData of chainInfos) {
            let tokenPrice = tokenPrices[chainData.symbol.toUpperCase()];
            if (!tokenPrice) {
                console.warn(`Harga token untuk ${chainData.Nama_Chain} tidak ditemukan`);
                continue;
            }

            try {
                const web3 = new Web3(new Web3.providers.HttpProvider(chainData.rpc));
                const block = await web3.eth.getBlock("pending");

                let baseFee;
                if (block?.baseFeePerGas !== undefined) {
                    baseFee = Number(block.baseFeePerGas);
                } else {
                    baseFee = Number(await web3.eth.getGasPrice());
                }

                const gwei = (baseFee / 1e9) * 2; // buffer *2
                const gasUSD = (gwei * chainData.gasLimit * tokenPrice) / 1e9;

                gasResults.push({
                    chain: chainData.Nama_Chain,
                    key: chainData.key || chainData.symbol,
                    symbol: chainData.symbol,
                    tokenPrice,
                    gwei,
                    gasUSD
                });

                console.log(`üü¢ ${chainData.Nama_Chain} | Gwei: ${gwei.toFixed(2)} | Token: ${chainData.symbol} | Price: $${tokenPrice} | Fee ‚âà $${gasUSD.toFixed(4)}`);

            } catch (err) {
                console.error(`‚ùå Gagal ambil data gas untuk ${chainData.Nama_Chain}:`, err);
            }
        }

        // üíæ Simpan array hasil ke localStorage
        saveToLocalStorage("ALL_GAS_FEES", gasResults);
    }

    // Fungsi untuk menonaktifkan semua input di dalam form
    function form_off() {
        $('input, select, textarea, button').prop('disabled', true); 
    }

    // Fungsi untuk mengaktifkan semua input di dalam form
    function form_on() {
        $('input, select, button').prop('disabled', false);
    }

function flattenDataKoin(dataTokens) {
  if (!Array.isArray(dataTokens)) {
    try { dataTokens = JSON.parse(dataTokens || '[]'); } catch { dataTokens = []; }
  }
  let flatResult = [];
  let counter = 1;

  const setting = getFromLocalStorage('SETTING_SCANNER', {}) || {};
  const selectedFilterCEX = Array.isArray(setting.FilterCEXs) ? setting.FilterCEXs.map(x => String(x).toUpperCase()) : [];
  const isAllCexActive = selectedFilterCEX.length === 0; // kosong = semua aktif

  dataTokens.forEach(item => {
    if (!item.status) return;

    (item.selectedCexs || []).forEach(cex => {
      const cexUpper = String(cex).toUpperCase();
      if (!isAllCexActive && !selectedFilterCEX.includes(cexUpper)) return; // filter CEX

      const cexInfo = item.dataCexs?.[cexUpper] || {};
      const dexArray = (item.selectedDexs || []).map(dex => ({
        dex: dex,
        left: item.dataDexs?.[dex]?.left || 0,
        right: item.dataDexs?.[dex]?.right || 0
      }));

      flatResult.push({
        no: counter++,
        id: item.id,
        cex: cexUpper,
        feeWDToken: parseFloat(cexInfo.feeWDToken) || 0,
        feeWDPair:  parseFloat(cexInfo.feeWDPair)  || 0,
        depositToken: !!cexInfo.depositToken,
        withdrawToken: !!cexInfo.withdrawToken,
        depositPair: !!cexInfo.depositPair,
        withdrawPair: !!cexInfo.withdrawPair,
        chain: item.chain,
        symbol_in: item.symbol_in,
        sc_in: item.sc_in,
        des_in: item.des_in,
        symbol_out: item.symbol_out,
        sc_out: item.sc_out,
        des_out: item.des_out,
        status: item.status,
        dexs: dexArray
      });
    });
  });

  return flatResult;
}
    
function cekDataAwal() {
  let info = true;
  let errorMessages = [];

  let DataTokens = getFromLocalStorage('TOKEN_SCANNER', []);
  let SavedSettingData = getFromLocalStorage('SETTING_SCANNER', {});

  if (!Array.isArray(DataTokens) || DataTokens.length === 0) {
    errorMessages.push("‚ùå Tidak ada data token yang tersedia.");
    toastr.error("Tidak ada data token yang tersedia");
    scanner_form_off?.();
    info = false;
  }

  if (!SavedSettingData || Object.keys(SavedSettingData).length === 0) {
    errorMessages.push("‚ö†Ô∏è Cek SETTINGAN aplikasi {USERNAME, WALLET ADDRESS, JEDA}!");
    $("#SettingConfig").addClass("icon-wrapper");
    form_off();
    info = false;
  }

  if (info) {
    console.info('‚è≥ Memulai proses Memuat DATA KOIN');
    console.time('‚è±Ô∏è Waktu eksekusi Memuat DATA KOIN');

    const allowedChains = (SavedSettingData.AllChains || []).map(c => String(c).toLowerCase());
    const flatTokens = flattenDataKoin(DataTokens);

    const filteredByChain = flatTokens
      .filter(token => allowedChains.includes(String(token.chain || '').toLowerCase()))
      .sort((a, b) => {
        const A = (a.symbol_in || '').toUpperCase();
        const B = (b.symbol_in || '').toUpperCase();
        return A < B ? -1 : A > B ? 1 : 0;
      });

    console.timeEnd('‚è±Ô∏è Waktu eksekusi Memuat DATA KOIN');
    console.info('‚úÖ Proses Memuat DATA KOIN selesai.');

    // Render filter CHAIN & CEX
    generateInputCheckbox(CONFIG_CHAINS, "chain-options", "C", "CHAIN : &nbsp;", "uk-form-label uk-text-primary", 'chain');
    generateInputCheckbox(CONFIG_CEX,    "cex-filter",   "X", "CEX : &nbsp;",   "uk-form-label uk-text-primary", 'cex');

    // Render tabel awal
    try { refreshTokensTable(); } catch (e) { console.error(e); }
  }

  const managedChains = getManagedChains?.() || [];
  if (managedChains.length > 0) {
    const chainParam = encodeURIComponent(managedChains.join(','));
    const link = $('a[href="index.html"]');
    if (link.length > 0) {
      let href = link.attr('href') || '';
      href = href.split('?')[0] || 'index.html';
      link.attr('href', `${href}?chains=${chainParam}`);
    }
  }

  if (!info) {
    $("#infoAPP").show().html(errorMessages.join("<br/>"));
  }

  const dataACTION = getFromLocalStorage('HISTORY');
  if (dataACTION && dataACTION.time) {
    $("#infoAPP").show().text(`${dataACTION.action} at ${dataACTION.time}`);
  }
}

    function hexToRgba(hex, alpha) {
        var r = parseInt(hex.slice(1, 3), 16);
        var g = parseInt(hex.slice(3, 5), 16);
        var b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function formatPrice(price) {
        if (price >= 1) {
            return price.toFixed(3) + '$'; // Jika >= 1, tampilkan 2 angka desimal
        }

        let strPrice = price.toFixed(20).replace(/0+$/, ''); // Paksa format desimal, hapus nol di akhir
        let match = strPrice.match(/0\.(0*)(\d+)/); // Ambil nol setelah koma dan angka signifikan

        if (match) {
            let zeroCount = match[1].length; // Hitung jumlah nol setelah koma
            let significant = match[2].substring(0, 4); // Ambil 5 digit signifikan pertama

            // Jika angka signifikan kurang dari 5 digit, tambahkan nol di akhir
            significant = significant.padEnd(4, '0');

            if (zeroCount >= 2) {
                return `0.{${zeroCount}}${significant}$`; // Format dengan {N} jika nol >= 2
            } else {
                return `0.${match[1]}${significant}$`; // Format biasa jika nol < 2
            }
        }

        return price.toFixed(6) + '$'; // Fallback jika format tidak dikenali
    }

    function getCexData(token) {
        try {
            if (!token || typeof token !== 'object') return null;
            if (!token.modalCexs || typeof token.modalCexs !== 'object') return null;
            if (!token.cex || typeof token.cex !== 'string') return null;
            
            const upperCex = token.cex.toUpperCase();
            return token.modalCexs[upperCex] || null;
        } catch (error) {
            console.error('Error in getCexData:', error);
            return null;
        }
    }

    // Fungsi untuk mendapatkan warna CEX
    function getWarnaCEX(cex) {
        // Early return if cex is invalid
        if (!cex || typeof cex !== 'string') {
            console.warn('Parameter CEX kosong atau tidak valid:', cex);
            return 'black';
        }

        try {
            const upperCex = cex.toUpperCase();
            
            // Cek di CONFIG_CEX terlebih dahulu
            if (CONFIG_CEX && CONFIG_CEX[upperCex] && CONFIG_CEX[upperCex].WARNA) {
                return CONFIG_CEX[upperCex].WARNA;
            }

            // Jika tidak ada di CONFIG_CEX, ambil dari TOKEN_SCANNER
            const tokens = getFromLocalStorage('TOKEN_SCANNER', []);
            const tokenWithCex = tokens.find(t => t.cex && t.cex.toUpperCase() === upperCex);
            
            if (tokenWithCex?.modalCexs?.[upperCex]) {
                const cexData = tokenWithCex.modalCexs[upperCex];
                if (cexData.withdrawToken && cexData.depositToken) {
                    return '#008000'; // Hijau jika withdraw dan deposit aktif
                } else if (!cexData.withdrawToken && !cexData.depositToken) {
                    return '#FF0000'; // Merah jika keduanya nonaktif
                } else {
                    return '#FFA500'; // Orange jika salah satu aktif
                }
            }

            return 'black'; // Warna default
        } catch (error) {
            console.error('Error dalam getWarnaCEX:', error);
            return 'black';
        }
    }

function countTokensPerCEXFilteredByChains() {
  const setting = getFromLocalStorage('SETTING_SCANNER', {}) || {};
  const chains  = (setting.AllChains || []).map(s => String(s).toLowerCase());
  const arr     = getFromLocalStorage('TOKEN_SCANNER', []);
  const onArr   = Array.isArray(arr) ? arr.filter(t => t && t.status) : [];
  const byCex   = {};

  onArr.forEach(t => {
    const chainLower = String(t.chain || '').toLowerCase();
    if (chains.length && !chains.includes(chainLower)) return;
    (t.selectedCexs || []).forEach(cx => {
      const k = String(cx).toUpperCase();
      byCex[k] = (byCex[k] || 0) + 1;
    });
  });
  return byCex; // { BINANCE: n, GATE: m, ... }
}

function generateInputCheckbox(items, containerId, idPrefix, labelText, style, type = 'cex') {
  if (type !== 'cex' && type !== 'chain') return;

  const $container = $(`#${containerId}`);
  $container.empty();

  // Settings
  let settingData = getFromLocalStorage('SETTING_SCANNER', {}) || {};
  let selectedChains = Array.isArray(settingData.AllChains)
    ? settingData.AllChains.map(x => String(x).toLowerCase())
    : [];

  // Ukuran font yang rapi
  const CEX_FONT_SIZE = 14;   // px
  const CHAIN_FONT_SIZE = 13; // px

  // Header
  $container.append(`
    <b><span class="uk-text-secondary uk-text-medium">${labelText}</span></b>
  `);

  const itemsArr = Object.keys(items || {});

  // Data untuk badge
  const tokenScanner = getFromLocalStorage('TOKEN_SCANNER', []);
  const tokensArray  = Array.isArray(tokenScanner) ? tokenScanner : [];

  // Count per chain (token ON)
  const countByChain = tokensArray
    .filter(t => t && t.status)
    .reduce((acc, t) => {
      const k = String(t.chain || '').toLowerCase();
      if (!k) return acc;
      acc[k] = (acc[k] || 0) + 1;
      return acc;
    }, {});

  // Count per CEX (token ON & respect selected chains)
  const countByCex = tokensArray
    .filter(t => t && t.status)
    .reduce((acc, t) => {
      const chainLower = String(t.chain || '').toLowerCase();
      if (selectedChains.length && !selectedChains.includes(chainLower)) return acc;
      (t.selectedCexs || []).forEach(cx => {
        const k = String(cx).toUpperCase();
        acc[k] = (acc[k] || 0) + 1;
      });
      return acc;
    }, {});

  // CEX filter persisted
  const persistedFilterCEX = Array.isArray(settingData.FilterCEXs)
    ? settingData.FilterCEXs.map(x => String(x).toUpperCase())
    : [];
  
  const hasFilterCEX = persistedFilterCEX.length > 0;
  
  const wrapper = $('<div style="display:flex; flex-wrap:wrap; gap:10px;"></div>');

  itemsArr.forEach(item => {
    const lower = String(item).toLowerCase();
    const upper = String(item).toUpperCase();

    // Warna dari config.js
    let color = '#333';
    if (type === 'cex') {
      const cfg = (window.CONFIG_CEX || items || {})[upper];
      if (cfg && cfg.WARNA) color = cfg.WARNA;
    } else {
      const cfg = (window.CONFIG_CHAINS || items || {})[lower];
      if (cfg && cfg.WARNA) color = cfg.WARNA;
    }

    // Label & tooltip
    let labelTextShow, tooltipText, isChecked, badgeCount;

    if (type === 'chain') {
      const cd = (window.CONFIG_CHAINS || items || {})[lower];
      labelTextShow = (cd && (cd.Nama_Pendek || cd.SHORT_NAME)) ? (cd.Nama_Pendek || cd.SHORT_NAME) : upper.substring(0,3);
      tooltipText   = (cd && cd.Nama_Chain) ? cd.Nama_Chain : upper;
      isChecked     = selectedChains.includes(lower);
      badgeCount    = countByChain[lower] || 0;
    } else {
      labelTextShow = upper;
      tooltipText   = upper;
      isChecked     = hasFilterCEX ? persistedFilterCEX.includes(upper) : false;
      badgeCount    = countByCex[upper] || 0;
    }

    const checkboxId = `${idPrefix}${upper}`;
    const inlineStyle = `color:${color}; font-weight:bolder; line-height:1; display:inline-block;`;

    const html = `
      <label class="uk-text-small" title="${tooltipText}">
        <input type="checkbox" id="${checkboxId}" class="uk-checkbox ${type}-item" value="${upper}" ${isChecked ? 'checked' : ''}>
        <span style="${inlineStyle}">${String(labelTextShow).toUpperCase()}</span>
        <span>[${badgeCount}]</span>
      </label>
    `;

    wrapper.append(html);
  });

  $container.append(wrapper);

  // Handler perubahan (persist ke localStorage)
  $container.off('change.checkbox').on('change.checkbox', 'input[type="checkbox"]', function(){
    const valUpper = String(this.value).toUpperCase();
    const valLower = String(this.value).toLowerCase();

    if ($(this).hasClass('chain-item') || type === 'chain') {
      let chains = Array.isArray(settingData.AllChains) ? settingData.AllChains.map(x => String(x).toLowerCase()) : [];
      if (this.checked) {
        if (!chains.includes(valLower)) chains.push(valLower);
        toastr.info(`CHAIN ${valUpper} DITAMBAH`);
      } else {
        if (chains.length <= 1) {
          toastr.warning('Minimal harus ada 1 chain yang dipilih!');
          this.checked = true;
          return;
        }
        chains = chains.filter(c => c !== valLower);
        toastr.info(`CHAIN ${valUpper} DIHAPUS`);
      }
      settingData.AllChains = chains;
      saveToLocalStorage('SETTING_SCANNER', settingData);
      // re-render CEX agar badge ikut chain baru
      try {
        generateInputCheckbox(CONFIG_CEX, 'cex-filter', 'X', 'CEX: ', 'uk-form-label uk-text-primary', 'cex');
        refreshTokensTable();
      } catch(_) { location.reload(); }
      return;
    }

    // CEX
    let filter = Array.isArray(settingData.FilterCEXs) ? settingData.FilterCEXs.map(x => String(x).toUpperCase()) : [];
    if (this.checked) {
      if (!filter.includes(valUpper)) filter.push(valUpper);
      toastr.info(`CEX ${valUpper} AKTIF`);
    } else {
      filter = filter.filter(x => x !== valUpper);
      if (filter.length === 0) {
        toastr.warning('Tidak memilih CEX mana pun = SEMUA CEX aktif.');
      } else {
        toastr.info(`CEX ${valUpper} NONAKTIF`);
      }
    }
    settingData.FilterCEXs = Array.from(new Set(filter));
    saveToLocalStorage('SETTING_SCANNER', settingData);
    try { refreshTokensTable(); } catch(_) { location.reload(); }
  });
}

function loadSignalData() {
    const dexList = Object.keys(CONFIG_DEXS || {});
    const appSettings = getFromLocalStorage('SETTING_SCANNER', {}) || {};

    const sinyalContainer = document.getElementById('sinyal-container');
    if (!sinyalContainer) return;

    // Bersihkan isi & set ulang grid
    sinyalContainer.innerHTML = '';
    sinyalContainer.setAttribute('uk-grid', '');

    // Gunakan uk-child-width-expand ‚Üí tiap card bagi lebar penuh 1 baris
    sinyalContainer.className = 'uk-grid uk-grid-small uk-child-width-expand';

    dexList.forEach((dex, index) => {
        // Grid item
        const gridItem = document.createElement('div');

        // Card
        const card = document.createElement('div');
        card.classList.add('uk-card', 'uk-card-default', 'uk-card-hover');
        card.style.borderRadius = '5px';
        card.style.overflow = 'hidden';
        card.style.border = '1px solid black';
        card.style.paddingBottom = '10px';
        card.style.marginTop = '10px';

        // Header
        const cardHeader = document.createElement('div');
        cardHeader.classList.add('uk-card-header', 'uk-padding-remove-vertical', 'uk-padding-small');
        cardHeader.style.backgroundColor = '#e5ebc6';
        cardHeader.style.height = '30px';
        cardHeader.style.display = 'flex';
        cardHeader.style.alignItems = 'center';
        cardHeader.style.justifyContent = 'space-between';
        cardHeader.style.borderBottom = '1px solid black';

        const bodyId = `body-${String(dex).toLowerCase()}-${index}`;
        cardHeader.innerHTML = `
            <div class="uk-flex uk-flex-middle" style="gap:8px;">
                <span class="uk-text-bold" style="color:black !important; font-size:14px;">
                    ${String(dex).toUpperCase()}
                </span>
            </div>
            <a class="uk-icon-link uk-text-danger uk-text-bolder"
               uk-icon="chevron-up"
               uk-toggle="target: #${bodyId}"></a>
        `;

        // Body
        const cardBody = document.createElement('div');
        cardBody.classList.add('uk-card-body', 'uk-padding-remove');
        cardBody.id = bodyId;

        // Konten sinyal
        const signalSpan = document.createElement('div');
        signalSpan.setAttribute('id', `sinyal${String(dex).toLowerCase()}`);
        signalSpan.style.fontSize = '13.5px';

        // Rakit
        cardBody.appendChild(signalSpan);
        card.appendChild(cardHeader);
        card.appendChild(cardBody);
        gridItem.appendChild(card);
        sinyalContainer.appendChild(gridItem);
    });

    // Re-render UIkit grid
    UIkit.update(sinyalContainer);
}

    function createLink(url, text, className = '') {
        return url
            ? `<a href="${url}" target="_blank" class="${className}"><b>${text}</b></a>`
            : `<b>${text}</b>`;
    }
    
    //generate url cex
    function GeturlExchanger(cex, NameToken, NamePair) {
        // Check for undefined or null values
        if (!NameToken || !NamePair) {
            console.warn('Missing token names in GeturlExchanger:', { cex, NameToken, NamePair });
            return {
                tradeToken: '#',
                tradePair: '#',
                withdrawUrl: '#',
                depositUrl: '#',
                withdrawTokenUrl: '#',
                depositTokenUrl: '#',
                withdrawPairUrl: '#',
                depositPairUrl: '#'
            };
        }

        // Konversi nama token dan pasangan ke uppercase
        const token = NameToken.toString().toUpperCase();
        const pair = NamePair.toString().toUpperCase();

        let baseUrlTradeToken = token === "USDT" ? "#" : null;
        let baseUrlTradePair = pair === "USDT" ? "#" : null;
        let baseUrlWithdraw = null;
        let baseUrlDeposit = null;

        // Menentukan URL berdasarkan nilai cex
        if (cex === "GATE") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.gate.com/trade/${token}_USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.gate.com/trade/${pair}_USDT`;
            baseUrlWithdraw = `https://www.gate.com/myaccount/withdraw/${token}`;
            baseUrlDeposit = `https://www.gate.com/myaccount/deposit/${pair}`;
        } else if (cex === "BINANCE") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.binance.com/en/trade/${token}_USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.binance.com/en/trade/${pair}_USDT`;
            baseUrlWithdraw = `https://www.binance.com/en/my/wallet/account/main/withdrawal/crypto/${token}`;
            baseUrlDeposit = `https://www.binance.com/en/my/wallet/account/main/deposit/crypto/${pair}`;
        } else if (cex === "KUCOIN") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.kucoin.com/trade/${token}-USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.kucoin.com/trade/${pair}-USDT`;
            baseUrlWithdraw = `https://www.kucoin.com/assets/withdraw/${token}`;
            baseUrlDeposit = `https://www.kucoin.com/assets/coin/${pair}`;
        } else if (cex === "BITGET") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.bitget.com/spot/${token}USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.bitget.com/spot/${pair}USDT`;
            baseUrlWithdraw = `https://www.bitget.com/asset/withdraw`;
            baseUrlDeposit = `https://www.bitget.com/asset/recharge`;
        } else if (cex === "BYBIT") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.bybit.com/en/trade/spot/${token}/USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.bybit.com/en/trade/spot/${pair}/USDT`;
            baseUrlWithdraw = "https://www.bybit.com/user/assets/withdraw";
            baseUrlDeposit = "https://www.bybit.com/user/assets/deposit";
        } else if (cex === "MEXC") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.mexc.com/exchange/${token}_USDT?_from=search`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.mexc.com/exchange/${pair}_USDT?_from=search`;
            baseUrlWithdraw = `https://www.mexc.com/assets/withdraw/${token}`;
            baseUrlDeposit = `https://www.mexc.com/assets/deposit/${pair}`;
        } else if (cex === "OKX") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.okx.com/trade-spot/${token}-usdt`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.okx.com/trade-spot/${pair}-usdt`;
            baseUrlWithdraw = `https://www.okx.com/balance/withdrawal/${token}-chain`;
            baseUrlDeposit = `https://www.okx.com/balance/recharge/${pair}`;
        }
        else if (cex === "BITMART") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.bitmart.com/trade/en-US?symbol=${token}_USDT&type=spot`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.bitmart.com/trade/en-US?symbol=${pair}_USDT&type=spot`;
            baseUrlWithdraw = `https://www.bitmart.com/asset-withdrawal/en-US`;
            baseUrlDeposit = `https://www.bitmart.com/asset-deposit/en-US`;
        }
        else if (cex === "INDODAX") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://indodax.com/market/${token}IDR`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://indodax.com/market/${pair}IDR`;
            baseUrlWithdraw = `https://indodax.com/finance/${token}#kirim`;
            baseUrlDeposit = `https://indodax.com/finance/${token}`;
        }

        return {
            tradeToken: baseUrlTradeToken,
            tradePair: baseUrlTradePair,
            // Back-compat fields (keep):
            withdrawUrl: baseUrlWithdraw,
            depositUrl: baseUrlDeposit,
            // Standardized fields used by UI:
            withdrawTokenUrl: baseUrlWithdraw,
            depositTokenUrl: baseUrlDeposit,
            withdrawPairUrl: baseUrlWithdraw,
            depositPairUrl: baseUrlDeposit
        };
    }

    // Fungsi untuk mengurutkan tabel
    function sortTable(columnIndex) {
        const rows = $('#dataTableBody tr').get();

        rows.sort(function(a, b) {
            const keyA = $(a).children('td').eq(columnIndex).text().toUpperCase();
            const keyB = $(b).children('td').eq(columnIndex).text().toUpperCase();

            if (sortOrder[columnIndex] === undefined) {
                sortOrder[columnIndex] = true; // Default ke urutan naik
            }

            if (keyA < keyB) return sortOrder[columnIndex] ? -1 : 1;
            if (keyA > keyB) return sortOrder[columnIndex] ? 1 : -1;
            return 0;
        });

        // Kosongkan tabel dan tambahkan kembali baris yang sudah diurutkan
        $('#dataTableBody').empty().append(rows);

        // Update kolom No agar tetap berurutan
        $('#dataTableBody tr').each((index, row) => {
            $(row).children('td').first().text(index + 1); // Set nomor berurutan
        });

        // Toggle urutan untuk kolom yang sama
        sortOrder[columnIndex] = !sortOrder[columnIndex];
        updateSortIcons();
    }

    // Memperbarui ikon urutan
    function updateSortIcons() {
        $('.sort-icon').html(''); // Reset semua ikon
        for (let index in sortOrder) {
            const icon = sortOrder[index] ? '‚ñ≤' : '‚ñº';
            $('#sortIcon' + index).html(icon);
        }
    }

    function processOrderBook(data) {
        const priceBuy = data.bids.slice(0, 3).map(([price, volume]) => ({
            price: parseFloat(price),
            volume: parseFloat(volume) * parseFloat(price) // Volume dalam USD
        })).reverse(); // Membalik urutan priceBuy

        const priceSell = data.asks.slice(0, 3).map(([price, volume]) => ({
            price: parseFloat(price),
            volume: parseFloat(volume) * parseFloat(price) // Volume dalam USD
        })).reverse(); // Membalik urutan priceSell

        return { priceBuy, priceSell };
    }

    function getRateUSDT() {
        let ratePrice = {}; // Inisialisasi objek harga

        // Ambil harga USDT/IDR dari API Indodax
        $.getJSON('https://indodax.com/api/ticker/usdtidr')
            .done(function (responseIndodax) {
                if (responseIndodax?.ticker?.last) {
                    ratePrice["idr"] = parseFloat(responseIndodax.ticker.last);

                    // Simpan harga USDT ke IDR ke localStorage
                    saveToLocalStorage('PRICE_RATE_USDT', ratePrice.idr);
                    console.log("RATE USDT/IDR: " + ratePrice.idr);
                    // $("#rateUSDT").text("RATE USDT/IDR: " + ratePrice.idr);
                } else {
                    console.warn("Data USDT/IDR dari Indodax tidak valid:", responseIndodax);
                }
            })
            .fail(function (error) {
                console.error("Error fetching USDT/IDR price:", error);
                toastr.error('KONEKSI INDODAX KENA LIMIT!');
            });
    }

    // Fungsi untuk mendapatkan kredensial API secara acak
    function getRandomApiKeyOKX() {
        const randomIndex = Math.floor(Math.random() * apiKeysOKXDEX.length);
        return apiKeysOKXDEX[randomIndex];
    }  
       // Fungsi untuk Signature
    function calculateSignature(exchange, apiSecret, dataToSign, hashMethod = "HmacSHA256") {
        if (!apiSecret || !dataToSign) {
            console.error(`[${exchange}] API Secret atau Data untuk Signature tidak valid!`);
            return null;
        }
    
        switch (exchange.toUpperCase()) {
            case "MEXC":
            case "BINANCE":
            case "KUCOIN":
            case "BYBIT":
                // Gunakan HMAC-SHA256
                return CryptoJS[hashMethod](dataToSign, apiSecret).toString(CryptoJS.enc.Hex);
    
            case "OKX":
                // Gunakan BASE64 untuk OKX
                const hmac = CryptoJS.HmacSHA256(dataToSign, apiSecret);
                return CryptoJS.enc.Base64.stringify(hmac);
    
            default:
                console.error(`[${exchange}] Exchange tidak didukung untuk perhitungan signature.`);
                return null;
        }
    } 

    function DisplayPNL( PNL, cex, Coin_in, NameX, totalFee, modal, dex, priceCEX, priceDEX, FeeSwap, FeeWD, sc_input, sc_output, Coin_out, totalValue, totalModal, conclusion, selisih, nameChain, codeChain, trx, profitLossPercent, vol ) {
        // Ambil setting
        var filterPNLValue = parseFloat(SavedSettingData.filterPNL);
        var nickname = SavedSettingData.nickname;
        var totalValue = parseFloat(totalValue);
        var totalGet = totalValue - parseFloat(modal);
        var totalModal = parseFloat(totalModal);
        var totalFee = parseFloat(totalFee);
        var checkVol = $('#checkVOL').is(':checked');

        // Ambil link CEX
        const urlsCEXToken = GeturlExchanger(cex.toUpperCase(), Coin_in, Coin_out);
        var buyLink = urlsCEXToken.tradeToken;
        var sellLink = urlsCEXToken.tradePair;

        // Pastikan chainName lowercase untuk ambil config
        const chainName = nameChain.toLowerCase();
        const chainConfig = CONFIG_CHAINS[chainName];

        if (!chainConfig) {
            console.error(`‚ùå Chain configuration not found for: '${chainName}'`);
            return;
        }

        // Buat ID unik
        var IdCELL = `${cex.toUpperCase()}_${dex.toUpperCase()}_${NameX}_${(chainConfig.Nama_Chain).toUpperCase()}`;
        var rowCell = $(`#${IdCELL}`);
        var resultCell = $(`#RESULT_${IdCELL}`);
        var buyCell = $(`#BUY_${IdCELL}`);
        var sellCell = $(`#SELL_${IdCELL}`);

        // Buat teks sinyal
        var sinyals = `<a href="#SWAP_${cex.toUpperCase()}_${dex.toUpperCase()}_${NameX}_${(nameChain).toUpperCase()}" class='link-class'>
            ${cex.toUpperCase()} VS ${dex.toUpperCase()} : ${NameX} (${PNL.toFixed(2)}$)</a>`;

        // === LOGIKA LAMA (tetap, jika masih kamu perlukan di tempat lain)
        const isPNLPositive = (filterPNLValue === 0 && totalValue > totalModal) || ((totalValue - totalModal) > filterPNLValue);
        const isVolEnough = parseFloat(vol) >= parseFloat(modal);
        const canHighlight = (!checkVol && isPNLPositive) || (checkVol && isPNLPositive && isVolEnough);

        // === LOGIKA BARU: highlight bila PNL > totalFee ATAU PNL > filterPNLValue
        const isHighlight = (PNL > totalFee) || (PNL > filterPNLValue);

        // === GANTI KONDISI IF MENGGUNAKAN isHighlight
        if (isHighlight) {
            toastr.success(sinyals);

            // Ubah background ke aliceblue (hanya ini yang diubah dari style lama)
            rowCell.attr("style",
                "background-color: #94fa95 !important;" +
                "font-weight: bolder !important;" +
                "color: black !important;" +
                "vertical-align: middle !important;" +
                "text-align: center !important;"
            );

            let htmlFee = '';
            if (trx === "TokentoPair") {
                htmlFee = `<span style="color:#0f04e2 !important;">FeeWD: ${FeeWD.toFixed(2)}$</span> | 
                        ${createLink(urlsCEXToken.withdrawUrl, 'WD')}<br/>`;
            } else if (trx === "PairtoToken") {
                htmlFee = `<span style="color:#0f04e2 !important;">FeeWD: ${FeeWD.toFixed(2)}$</span> | 
                        ${createLink(urlsCEXToken.depositUrl, 'DP')}<br/>`;
            }
            let htmlResult = `
                ${htmlFee}
                <span style="color: #d20000;">All: ${totalFee.toFixed(2)}$</span>
                <span style="color: #1e87f0;">SW: ${FeeSwap.toFixed(2)}$</span><br/>
                <span style="color: #444;">GT: ${totalGet.toFixed(2)}$</span>
                <span style="color: #444;">PNL: ${PNL.toFixed(2)}$</span><br/>
            `;
            resultCell.html(htmlResult);

            if (!buyCell.parent().is("span")) {
                buyCell.wrap('<a href="' + buyLink + '" target="_blank"></a>');
            }
            if (!sellCell.parent().is("span")) {
                sellCell.wrap('<a href="' + sellLink + '" target="_blank"></a>');
            }

            InfoSinyal(dex.toLowerCase(), NameX, PNL, totalFee, cex.toUpperCase(), 
                    Coin_in, Coin_out, profitLossPercent, modal, nameChain, codeChain, trx);

        } else {
            resultCell.html(`
                <span style="color:black;" title="FEE WD CEX">FeeWD : ${FeeWD.toFixed(2)}$</span><br/>
                <span class="uk-text-danger" title="FEE ALL">ALL:${totalFee.toFixed(2)}$</span>
                <span class="uk-text-primary" title="FEE SWAP"> ${FeeSwap.toFixed(2)}$</span><br/>
                <span class="uk-text-success" title="GET BRUTO">GT:${totalGet.toFixed(2)}$</span>
                <span class="uk-text-warning" title="GET NETTO / PNL" > ${PNL.toFixed(2)}$</span>
            `);
            if (PNL > totalFee) {
                InfoSinyal(dex.toLowerCase(), NameX, PNL, totalFee, cex.toUpperCase(), 
                        Coin_in, Coin_out, profitLossPercent, modal, nameChain, codeChain, trx);
            }
        }

        // === Kirim TELE jika PNL > ambang (tetap)
        if (PNL > 0.25) {
            const direction = (trx === 'TokentoPair') ? 'cex_to_dex' : 'dex_to_cex';
            const priceBUY  = (direction === 'cex_to_dex') ? priceCEX : priceDEX;
            const priceSELL = (direction === 'cex_to_dex') ? priceDEX : priceCEX;

            const tokenData = {
                symbol: Coin_in,
                pairSymbol: Coin_out,
                contractAddress: sc_input,
                pairContractAddress: sc_output,
                chain: nameChain
            };

            MultisendMessage(
                cex, dex.toUpperCase(),
                tokenData, modal, PNL,
                priceBUY, priceSELL,
                FeeSwap, FeeWD, totalFee,
                nickname, direction
            );
        }
    }

  // Fungsi utama menampilkan sinyal
function InfoSinyal(DEXPLUS, TokenPair, PNL, totalFee, cex, NameToken, NamePair, profitLossPercent, modal, nameChain, codeChain, trx) {
    const chainData = getChainData(nameChain);

     // pakai key yang benar dari getChainData()
    const chainShort = String(
        chainData?.SHORT_NAME ||   // <-- ini ada
        chainData?.Nama_Chain ||   // fallback
        nameChain                  // fallback terakhir
    ).toUpperCase();

    const filterPNLValue = parseFloat(SavedSettingData.filterPNL);
    const warnaCEX = getWarnaCEX(cex);
    const warnaTeksArah = (trx === "TokentoPair") ? "uk-text-success" : "uk-text-danger";

    // ID anchor TETAP pakai nameChain upper agar match dengan ID baris yang existing
    const idCELL = `${cex.toUpperCase()}_${DEXPLUS.toUpperCase()}_${NameToken}_${NamePair}_${String(nameChain).toUpperCase()}`;

    // highlight jika PNL > filter
    const highlightStyle = (Number(PNL) > filterPNLValue) ? "background-color:#acf9eea6; font-weight:bolder;" : "";

    const sLink = `<div>
        <a href="#${idCELL}" class="buy" style="text-decoration:none; font-size:12px;">
            <span style="color:${warnaCEX}; display:inline-block; ${highlightStyle}; margin-left:4px; margin-top:6px;">
            üî∏ ${String(cex).slice(0,3).toUpperCase()}X<span class="uk-text-secondary">:${modal}</span>
            <span class="${warnaTeksArah}"> ${NameToken}->${NamePair}</span>
            <span class="uk-text-secondary">[${chainShort}]</span>:
            <span class="uk-text-warning">${Number(PNL).toFixed(2)}$</span>
            </span>
        </a>
        </div>`;

    // append ke kanal sinyal per-DEX
    $("#sinyal" + DEXPLUS.toLowerCase()).append(sLink);

    // efek suara
    const audio = new Audio('audio.mp3');
    audio.play();
    }
   // ALL Sent TELE
function sendStatusTELE(user, status) {
        var users = [
            { chat_id: -1002079288809 }
        ];
        var apiUrl = 'https://api.telegram.org/bot8053447166:AAH7YYbyZ4eBoPX31D8h3bCYdzEeIaiG4JU/sendMessage';
        var message =  
            //"\n ----------------------------------------------------"+
            "\n <b> #MULTISCAN_SCANNER </b>"+
            "\n <b> USER: </b>" + (user ? user.toUpperCase() : '-') +
            " [ <b>" + (status ? status.toUpperCase() : '-')+"</b> ]";
//            "\n ----------------------------------------------------";

        users.forEach(function(chatTarget) {
            var chatId = chatTarget.chat_id;
            $.ajax({
                url: apiUrl,
                method: "POST",
                data: {
                    chat_id: chatId,
                    text: message,
                    parse_mode: "HTML",
                    disable_web_page_preview: true
                }
            });
        });
    }

function MultisendMessage(
  cex, dex,                   // string
  tokenData,                  // { symbol, pairSymbol, contractAddress, pairContractAddress, chain }
  modal, PNL,                 // number
  priceBUY, priceSELL,        // number
  FeeSwap, FeeWD, totalFee,   // number
  nickname,                   // string
  direction                   // 'cex_to_dex' | 'dex_to_cex'
) {
  try {
    // Validasi minimal
    if (!tokenData || !tokenData.chain) {
      console.error('‚ùå tokenData/chain kosong:', tokenData);
      return;
    }

    const chainName   = String(tokenData.chain || '').toLowerCase();
    const chainConfig = CONFIG_CHAINS[chainName];
    if (!chainConfig) {
      console.error('‚ùå Chain configuration not found for:', chainName);
      return;
    }

    // Tentukan sisi BUY/SELL sesuai arah
    const fromSymbol = (direction === 'cex_to_dex') ? tokenData.symbol      : tokenData.pairSymbol;
    const toSymbol   = (direction === 'cex_to_dex') ? tokenData.pairSymbol  : tokenData.symbol;
    const scIn       = (direction === 'cex_to_dex') ? tokenData.contractAddress     : tokenData.pairContractAddress;
    const scOut      = (direction === 'cex_to_dex') ? tokenData.pairContractAddress : tokenData.contractAddress;

    // Link explorer
    const linkBuy  = `<a href="${chainConfig.URL_Chain}/token/${scIn}" target="_blank">${fromSymbol}</a>`;
    const linkSell = `<a href="${chainConfig.URL_Chain}/token/${scOut}" target="_blank">${toSymbol}</a>`;

    // Link DEX (contoh pakai DefiLlama)
    const dexTradeLink = `<a href="https://swap.defillama.com/?chain=${chainConfig.Nama_Chain}&from=${scIn}&to=${scOut}" target="_blank">${dex.toUpperCase()}</a>`;

    // Link CEX ‚Äì gunakan properti yang benar (tradeToken/tradePair)
    const urls = GeturlExchanger(String(cex).toUpperCase(), fromSymbol, toSymbol) || {};
    const cexLinkFrom = urls.tradeToken || '#';
    const cexLinkTo   = urls.tradePair  || '#';
    const linkCEX     = `<a href="${cexLinkFrom}" target="_blank">${String(cex).toUpperCase()}</a>`;

    // Pastikan angka aman
    const pBuy   = Number(priceBUY)   || 0;
    const pSell  = Number(priceSELL)  || 0;
    const feeSW  = Number(FeeSwap)    || 0;
    const feeWD  = Number(FeeWD)      || 0;
    const feeAll = Number(totalFee)   || 0;
    const pnl    = Number(PNL)        || 0;
    const cap    = Number(modal)      || 0;

    const message =
      `<b>#MULTISCAN #${String(chainConfig.Nama_Chain || chainName).toUpperCase()}</b>\n` +
      `<b>USER:</b> ~ ${nickname || '-'}\n` +
      `-----------------------------------------\n` +
      `<b>MARKET:</b> ${linkCEX} VS ${dexTradeLink}\n` +
      `<b>TOKEN-PAIR:</b> <b>#<a href="${cexLinkFrom}" target="_blank">${fromSymbol}</a>_<a href="${cexLinkTo}" target="_blank">${toSymbol}</a></b>\n` +
      `<b>MODAL:</b> $${cap} | <b>PROFIT:</b> ${pnl.toFixed(2)}$\n` +
      `<b>BUY:</b> ${linkBuy} @ ${pBuy}\n` +
      `<b>SELL:</b> ${linkSell} @ ${pSell}\n` +
      `<b>FEE WD:</b> ${feeWD.toFixed(3)}$ \n` +
      `<b>FEE TOTAL:</b> $${feeAll.toFixed(2)} | <b>SWAP:</b> $${feeSW.toFixed(2)}\n` +
      `-----------------------------------------`;

    // Kirim Telegram
    $.ajax({
      url: `https://api.telegram.org/bot8053447166:AAH7YYbyZ4eBoPX31D8h3bCYdzEeIaiG4JU/sendMessage`,
      method: "POST",
      data: {
        chat_id: -1002079288809,
        text: message,
        parse_mode: "HTML",
        disable_web_page_preview: true
      }
    })
    .done(function (res) {
     // console.log("‚úÖ Pesan terkirim", res);
    })
    .fail(function (xhr, status, error) {
    //  console.error("‚ùå Gagal kirim pesan:", status, error, xhr && xhr.responseText);
   //   toastr.error("Gagal kirim Telegram: " + (xhr && xhr.responseText ? xhr.responseText : error));
    });

  } catch (err) {
   // console.error('‚ùå MultisendMessage error:', err);
  }
}

    // Fungsi untuk Signature CEX
    function calculateSignature(exchange, apiSecret, dataToSign, hashMethod = "HmacSHA256") {
        if (!apiSecret || !dataToSign) {
            console.error(`[${exchange}] API Secret atau Data untuk Signature tidak valid!`);
            return null;
        }
    
        switch (exchange.toUpperCase()) {
            case "MEXC":
            case "BINANCE":
            case "KUCOIN":
            case "BYBIT":
                // Gunakan HMAC-SHA256
                return CryptoJS[hashMethod](dataToSign, apiSecret).toString(CryptoJS.enc.Hex);
    
            case "OKX":
                // Gunakan BASE64 untuk OKX
                const hmac = CryptoJS.HmacSHA256(dataToSign, apiSecret);
                return CryptoJS.enc.Base64.stringify(hmac);
    
            default:
                console.error(`[${exchange}] Exchange tidak didukung untuk perhitungan signature.`);
                return null;
        }
    }    

    function setLastAction(action) {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const month = (now.getMonth() + 1).toString().padStart(2, '0'); // Bulan dimulai dari 0
        const year = now.getFullYear();

        const formattedTime = `${hours}:${minutes}:${seconds} | ${day}/${month}/${year}`;

        const lastAction = {
            time: formattedTime,
            action: action
        };

        saveToLocalStorage("HISTORY", lastAction);
        $("#infoAPP").html(`${lastAction.action} at ${lastAction.time}`);
    }
    
    function updateTableVolCEX(finalResult, cex) {
        const cexName = cex.toUpperCase();
        const TokenPair = finalResult.token + "_" + finalResult.pair;
        const isIndodax = cexName === 'INDODAX';

        const getPriceIDR = priceUSDT => {
            const rateIDR = getFromLocalStorage("PRICE_RATE_USDT", 0);
            return rateIDR ? (priceUSDT * rateIDR).toLocaleString("id-ID", { style: "currency", currency: "IDR" }) : "N/A";
        };

        // LEFT: token ‚Üí pair
        const volumesBuyToken = isIndodax
            ? finalResult.volumes_buyToken.slice().sort((a, b) => b.price - a.price)
            : finalResult.volumes_buyToken.slice().sort((a, b) => b.price - a.price); // harga besar ‚Üí kecil

        const volumesSellPair = isIndodax
            ? finalResult.volumes_sellPair
            : finalResult.volumes_sellPair; // harga kecil ‚Üí besar

        // RIGHT: pair ‚Üí token
        const volumesBuyPair = isIndodax
            ? finalResult.volumes_buyPair.slice().sort((a, b) => b.price - a.price) // harga besar ‚Üí kecil
            : finalResult.volumes_buyPair.slice().sort((a, b) => b.price - a.price); 

        const volumesSellToken = isIndodax
            ? finalResult.volumes_sellToken
            : finalResult.volumes_sellToken.slice().sort((a, b) => b.price - a.price); // harga besar ‚Üí kecil

        $('#LEFT_' + cexName + '_' + TokenPair + '_' + finalResult.chainName.toUpperCase()).html(
            volumesBuyToken.map(data => `
                <span class='uk-text-success' title="IDR: ${getPriceIDR(data.price)}">
                    ${formatPrice(data.price || 0)} : <b>${data.volume.toFixed(2) || 0}$</b><br/>
                </span>
            `).join('') +
            `<span class='uk-text-primary uk-text-bolder'>${finalResult.token} -> ${finalResult.pair}</span><br/>` +
            volumesSellPair.map(data => `
                <span class='uk-text-danger' title="IDR: ${getPriceIDR(data.price)}">
                    ${formatPrice(data.price || 0)} : <b>${data.volume.toFixed(2) || 0}$</b><br/>
                </span>
            `).join('')
        );

        $('#RIGHT_' + cexName + '_' + TokenPair + '_' + finalResult.chainName.toUpperCase()).html(
            volumesBuyPair.map(data => `
                <span class='uk-text-success' title="IDR: ${getPriceIDR(data.price)}">
                    ${formatPrice(data.price || 0)} : <b>${data.volume.toFixed(2) || 0}$</b><br/>
                </span>
            `).join('') +
            `<span class='uk-text-primary uk-text-bolder'>${finalResult.pair} -> ${finalResult.token}</span><br/>` +
            volumesSellToken.map(data => `
                <span class='uk-text-danger' title="IDR: ${getPriceIDR(data.price)}">
                    ${formatPrice(data.price || 0)} : <b>${data.volume.toFixed(2) || 0}$</b><br/>
                </span>
            `).join('')
        );
    }
   
    function generateDexLink(dex,chainName,codeChain, NameToken, sc_input, NamePair, sc_output) {
        const link = {
            'kyberswap': `https://kyberswap.com/swap/${chainName}/${sc_input}-to-${sc_output}`,
            'kana': `https://app.paraswap.xyz/#/swap/${sc_input}-${sc_output}?version=6.2&network=${chainName}`,
            'odos': "https://app.odos.xyz",
            '0x': chainName.toLowerCase() === 'solana' 
                ? `https://matcha.xyz/tokens/solana/${sc_input}?sellChain=1399811149&sellAddress=${sc_output}` 
                : `https://matcha.xyz/tokens/${codeChain}/${sc_input.toLowerCase()}?buyChain=${codeChain}&buyAddress=${sc_output.toLowerCase()}`,
            '1inch': ` https://app.1inch.io/advanced/swap?network=${codeChain}&src=${sc_input.toUpperCase()}&dst=${sc_output.toUpperCase()}`,
          // '1inch': `https://app.1inch.io/#/${codeChain}/advanced/swap/${sc_input}/${sc_output}`,
            'okx': `https://www.okx.com/web3/dex-swap?inputChain=${codeChain}&inputCurrency=${sc_input}&outputChain=501&outputCurrency=${sc_output}`,
            'magpie': `https://app.magpiefi.xyz/swap/${chainName.toLowerCase()}/${NameToken.toUpperCase()}/${chainName.toLowerCase()}/${NamePair.toUpperCase()}`,
            'paraswap': `https://app.paraswap.xyz/#/swap/${sc_input}-${sc_output}?version=6.2&network=${chainName}`,
            'openocean' : `https://app.openocean.finance/swap/${chainName}/${sc_input}/${sc_output}`,
            'jupiter': `https://jup.ag/swap/${sc_input}-${sc_output}`,
            'lifi' : `https://jumper.exchange/?fromChain=${codeChain}&fromToken=${sc_input}&toChain=${codeChain}&toToken=${sc_output}`,
        };
        return link[dex] || null;
    }

    function getFeeSwap(chainName) {
        const allGasData = getFromLocalStorage("ALL_GAS_FEES");

        // cari data gas untuk chain yang sesuai
        const gasInfo = allGasData.find(g => g.chain.toLowerCase() === chainName.toLowerCase());
        if (!gasInfo) {
            console.error(`‚ùå Gas data not found for chain: ${chainName}`);
            return 0;
        }

        // ambil GASLIMIT dari CONFIG_CHAINS
        const chainConfig = CONFIG_CHAINS[chainName.toLowerCase()];
        if (!chainConfig) {
            console.error(`‚ùå Chain config not found for: ${chainName}`);
            return 0;
        }

        const gasLimit = parseFloat(chainConfig.GASLIMIT || 250000); // default kalau tidak ada
        const feeSwap = ((parseFloat(gasInfo.gwei) * gasLimit) / Math.pow(10, 9)) * parseFloat(gasInfo.tokenPrice);

        return feeSwap;
    }

    function ResultEksekusi(amount_out, FeeSwap, sc_input, sc_output, cex, Modal, amount_in, priceBuyToken_CEX, priceSellToken_CEX, priceBuyPair_CEX, priceSellPair_CEX, Name_in, Name_out, feeWD, dextype,nameChain,codeChain, trx, vol,DataDEX) {
        // console.log("DataDEX",DataDEX);    
         
        var NameX = Name_in + "_" + Name_out;
            var FeeWD = parseFloat(feeWD);
            var FeeTrade = parseFloat(0.0014 * Modal);
    
            FeeSwap = parseFloat(FeeSwap);    
            Modal = parseFloat(Modal);
            amount_in = parseFloat(amount_in);
            amount_out = parseFloat(amount_out);
            priceBuyToken_CEX = parseFloat(priceBuyToken_CEX);
            priceSellPair_CEX = parseFloat(priceSellPair_CEX);

            // Hitung harga rata-rata swap
            var rateSellTokenDEX = (amount_out * priceSellPair_CEX) / amount_in;
            var rateBuyPairDEX = (amount_in * priceBuyToken_CEX) / amount_out;
            var rateTokentoPair = amount_out / amount_in;

            // Hitung total nilai
            var totalModal = Modal + FeeSwap + FeeWD + FeeTrade;
            var totalFee = FeeSwap + FeeWD + FeeTrade;
            // Hitung nilai output dalam USDT
            var valueOutInUSDT = amount_out * priceSellPair_CEX; // Output DEX dalam USD via CEX
            var valueInInUSDT = amount_out * priceBuyToken_CEX; // Input DEX dalam USD via CEX
            
            // let totalValue = 0;
            // if (trx === "TokentoPair") {
            //     totalValue = valueOutInUSDT; // Untuk transaksi TokentoPair
            // } else if (trx === "PairtoToken") {
            //     totalValue = amount_out*priceSellToken_CEX; // Untuk transaksi PairtoToken
            // }
            var totalValue = amount_out * priceSellPair_CEX; // Nilai akhir (USDT)
                // console.warn("TOTAL VALUE",totalValue)
                // console.log("TOKEN BUY:",priceBuyToken_CEX);
                // console.log("TOKEN SELL:",priceSellToken_CEX);

                // console.log("PAIR BUY:",priceBuyPair_CEX);
                // console.log("PAIR SELL:",priceSellPair_CEX);
            
            var profitLoss = totalValue - totalModal;
            var profitLossPercent = totalModal !== 0 ? (profitLoss / totalModal) * 100 : 0;

            var filterPNLValue = parseFloat(SavedSettingData.filterPNL);
            var conlusion = "NO SELISIH";
            var selisih = false;

            if (filterPNLValue === 0) {
                if (totalValue > totalModal + totalFee) {
                    conlusion = "GET SIGNAL";
                    selisih = true;
                }
            } else {
                if ((totalValue - totalModal) > filterPNLValue) {
                    conlusion = "GET SIGNAL";
                    selisih = true;
                }
            }

            let IdCELL = `${cex.toUpperCase()}_${dextype.toUpperCase()}_${NameX}_${(nameChain).toUpperCase()}`;
            // console.log("ID CELL:", IdCELL);
            // console.log("INFO LINK DEX:",dextype,nameChain,codeChain,Name_in,sc_input, Name_out, sc_output);
            var linkDEX = generateDexLink(dextype,nameChain,codeChain,Name_in,sc_input, Name_out, sc_output);   

            if (!linkDEX) {
                console.error(`DEX Type "${dextype}" tidak valid atau belum didukung.`);
                return;
            }

            // Ambil rate IDR dari localStorage
            const rateUSDTtoIDR = getFromLocalStorage("PRICE_RATE_USDT", 0);
            const toIDR = usdt => rateUSDTtoIDR ? (usdt * rateUSDTtoIDR).toLocaleString("id-ID", {
                style: "currency",
                currency: "IDR"
            }) : "N/A";

            let titleInfo = `${DataDEX.dexTitle.toUpperCase()}: `;
            let RateSwap = "";

            if (stablecoins.includes(Name_in)) {
                titleInfo += `(${Name_in}->${Name_out}) : ${formatPrice(rateBuyPairDEX)}`;
                titleInfo += ` | ${toIDR(rateBuyPairDEX)}`;
                RateSwap = `<label class="uk-text-success" title="${titleInfo}">${formatPrice(rateBuyPairDEX)}</label>`;
            } else if (stablecoins.includes(Name_out)) {
                titleInfo += ` (${Name_in}->${Name_out}) : ${formatPrice(rateTokentoPair)}`;
                titleInfo += ` | ${toIDR(rateSellTokenDEX)}`;
                RateSwap = `<label class="uk-text-danger" title="${titleInfo}">${formatPrice(rateTokentoPair)}</label>`;
            } else {

                 if (trx === "TokentoPair") {
                     // Selain itu, ambil rate dari TOKEN (symbol_in)
                    titleInfo += ` ${formatPrice(rateTokentoPair)} ${Name_in}/${Name_out}`;
                    titleInfo += ` | ${toIDR(rateSellTokenDEX)}`;
                    RateSwap = `<label class="uk-text-primary" title="${titleInfo}">${formatPrice(rateSellTokenDEX)}</label>`;                   
                } else {
                    // Khusus USDT saat PairtoToken ‚Üí ambil rate dari PAIR (symbol_out)
                    titleInfo += ` ${formatPrice(rateBuyPairDEX/priceBuyToken_CEX)} ${Name_in}/${Name_out}`;
                    titleInfo += ` | ${toIDR(rateBuyPairDEX)}`;
                    RateSwap = `<label class="uk-text-primary" title="${titleInfo}">${formatPrice(rateBuyPairDEX)}</label>`;
                }
                

            }
        if ($(`#SWAP_${IdCELL}`).length > 0) {
            $(`#SWAP_${IdCELL}`).html(`<a href="${linkDEX}" target="_blank">${RateSwap}</a>`);
        }

        // Menampilkan PNL
        // Panggil fungsi tampilan hasil
        //console.log("INFO PNL",profitLoss, cex, Name_in, NameX, totalFee, Modal, dextype, priceBuyToken_CEX, rateSellTokenDEX, FeeSwap, FeeWD, sc_input, sc_output, Name_out, totalValue, totalModal, conlusion, selisih,nameChain,codeChain, trx, profitLossPercent); 
        DisplayPNL(profitLoss, cex, Name_in, NameX, totalFee, Modal, dextype, priceBuyToken_CEX, rateSellTokenDEX, FeeSwap, FeeWD, sc_input, sc_output, Name_out, totalValue, totalModal, conlusion, selisih,nameChain,codeChain, trx, profitLossPercent,vol);
    }

    $(document).ready(function() {  
        const config = JSON.parse(localStorage.getItem('MULTISCANNER_STATUS_RUN') || '{}');
        if (config.run === "YES") {
            $('#startSCAN').prop('disabled', true).text('Running...');
        } else {
            $('#startSCAN').prop('disabled', false).text('Start');
        }
        // dark mode change    
        const isDark = getFromLocalStorage("DARK_MODE", false);
        if (isDark) {
            $('body').addClass('dark-mode uk-dark').removeClass('uk-light');
        } else {
            $('body').removeClass('dark-mode uk-dark');
        }
            // Inisialisasi tabel token saat halaman siap
        $('title').text("MULTISCANNER");
        $('#namachain').text("MULTISCANNER");

        $('#sinyal-container').css('color',"black");
        $('h4#daftar,h4#judulmanajemenkoin').css({ 'color': 'white', 'background': `linear-gradient(to right, #5c9513, #ffffff)`, 'padding-left': '7px','border-radius': '5px' });

        refreshTokensTable();

       // console.log("DATA TOKEN FILTER",filteredTokens);

        updateDarkIcon(isDark);

        const managedChains = getManagedChains();
        
        const urlParams = new URLSearchParams(window.location.search);
        const chain = urlParams.get('chain'); // Default ke 'eth' jika chain tidak ditemukan di URL

       // cekDataAwal();

        $('.sort-toggle').off('click').on('click', function () {
            $('.sort-toggle').removeClass('active');
            $(this).addClass('active');

            const sortValue = $(this).data('sort');

            // clone supaya originalTokens tidak terubah
            const sortedData = [...originalTokens].sort((a, b) => {
                const A = (a.symbol_in || "").toUpperCase();
                const B = (b.symbol_in || "").toUpperCase();
                if (A < B) return sortValue === "opt_A" ? -1 : 1; // A-Z
                if (A > B) return sortValue === "opt_A" ?  1 : -1; // Z-A
                return 0;
            });

            // SIMPAN GLOBAL supaya startSCAN mengikuti urutan ini
            window.filteredTokens = sortedData;

            // Render ulang tabel TANPA mengubah urutan (false = jangan re-sort di dalam fungsi)
            loadKointoTable(window.filteredTokens, false);
            console.log("DATA TERURUT", sortValue, window.filteredTokens);
        });
       
        $('#btn-save-setting').on('click', function() {
    const nickname = $('#user').val().trim();
    let filterPNL = parseFloat($('#inFilterPNL').val());
    const jedaTimeGroup = parseInt($('#jeda-time-group').val(), 10);
    const jedaKoin = parseInt($('#jeda-koin').val(), 10);
    const walletMeta = $('#walletMeta').val().trim();

    const scanPerKoin = $('input[name="koin-group"]:checked').val();
    const speedScan = $('input[name="waktu-tunggu"]:checked').val();

    // ==== Validasi wajib ====
    if (!nickname) return UIkit.notification({message: 'Nickname harus diisi!', status: 'danger'});
    if (!jedaTimeGroup || jedaTimeGroup <= 0) return UIkit.notification({message: 'Jeda / Group harus lebih dari 0!', status: 'danger'});
    if (!jedaKoin || jedaKoin <= 0) return UIkit.notification({message: 'Jeda / Koin harus lebih dari 0!', status: 'danger'});
    if (!walletMeta) return UIkit.notification({message: 'Wallet Address harus diisi!', status: 'danger'});
    if (!walletMeta.startsWith('0x')) return UIkit.notification({message: 'Wallet Address harus diawali dengan "0x"!', status: 'danger'});
    if (!scanPerKoin) return UIkit.notification({message: 'Pilih opsi KOIN / GRUP!', status: 'danger'});
    if (!speedScan) return UIkit.notification({message: 'Pilih opsi WAKTU TUNGGU!', status: 'danger'});

    // ==== Ambil nilai input CEX ====
    let JedaCexs = {};
    $('.cex-modal-input').each(function() {
        const cex = $(this).data('cex');
        const val = parseFloat($(this).val()) || 30; // default 30
        JedaCexs[cex] = val;
    });

    // ==== Ambil nilai input DEX ====
    let JedaDexs = {};
    $('.dex-modal-input').each(function() {
        const dex = $(this).data('dex');
        const val = parseFloat($(this).val()) || 100; // default 100
        JedaDexs[dex] = val;
    });

    let FilterCEXs = Object.keys(CONFIG_CEX);
    let AllChains = Object.keys(CONFIG_CHAINS);
    // ==== Buat data setting ====
    const settingData = {
        nickname,
        jedaTimeGroup,
        jedaKoin,
        filterPNL: filterPNL,
        walletMeta,
        scanPerKoin: parseInt(scanPerKoin, 10),
        speedScan: parseFloat(speedScan),
        JedaCexs,
        JedaDexs,
        AllChains,
        FilterCEXs
    };

    // Simpan
    saveToLocalStorage('SETTING_SCANNER', settingData);
    alert("‚úÖ SETTING SCANNER BERHASIL");
    location.reload();
});

        UIkit.util.on('#modal-setting', 'show', function () {
            form_on();
        });
                               
        // Create chain links langsung dari CONFIG_CHAINS
        Object.keys(CONFIG_CHAINS).forEach(chainKey => {
            const chainData = CONFIG_CHAINS[chainKey];
            if (!chainData) return;

            const linkHTML = `
                <span class="chain-link">
                    <a href="../index.html?chain=${chainKey}" target="_blank">
                        <img src="${chainData.ICON}" 
                            alt="${chainData.Nama_Chain} icon" 
                            width="24"
                            title="${chainData.Nama_Chain}">
                    </a>
                </span>
            `;
            $('#chain-links-container').append(linkHTML);
        });

        $('#searchInput').on('input', function() {
            const searchValue = $(this).val().toLowerCase();
            $('#dataTableBody tr').filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(searchValue) > -1);
            });
        });

        $('.posisi-check').on('change', function () {
            const kiri = $('input[value="Actionkiri"]');
            const kanan = $('input[value="ActionKanan"]');
            
            // Cek jumlah yang dicentang
            const checkedCount = $('.posisi-check:checked').length;

            if (checkedCount === 0) {
                // Kembalikan checkbox ini ke posisi sebelumnya (ON)
                $(this).prop('checked', true);
                toastr.error("Minimal salah satu POSISI harus aktif!");
                return;
            }else{
                $("#startSCAN").show();
            }

            const label = $(this).val() === 'Actionkiri' ? 'KIRI' : 'KANAN';
            const status = $(this).is(':checked') ? 'AKTIF' : 'NONAKTIF';
            toastr.info(`POSISI ${label} ${status}`);
        });

        $("#reload").click(function () {
            const config = JSON.parse(localStorage.getItem('MULTISCANNER_STATUS_RUN') || '{}');

            if (config.run === "YES") {
                const confirmReset = confirm("‚ö†Ô∏è APAKAH ANDA INGIN RESET PROSES? \n JIKA ADA PROSES SCANNING MAKA AKAN DIHENTIKAN?");
                
                if (confirmReset) {
                    config.run = "NO"; // hentikan proses scan
                    localStorage.setItem('MULTISCANNER_STATUS_RUN', JSON.stringify(config));
                    location.reload(); // reload halaman
                } else {
                    // User menolak, tidak lakukan apa-apa
                    console.log("Reload dibatalkan oleh pengguna.");
                }
            } else {
                // Tidak sedang scan, langsung reload
                location.reload();
            }
        });     

        $("#stopSCAN").click(function () {
                // Ambil config dari localStorage terlebih dahulu
                const config = JSON.parse(localStorage.getItem('MULTISCANNER_STATUS_RUN') || '{}');

                // Cek jika sedang berjalan
                if (config.run === "YES") {
                    // Ubah menjadi "NO"
                    config.run = "NO";
                    localStorage.setItem('MULTISCANNER_STATUS_RUN', JSON.stringify(config));

                    // Jalankan efek stop langsung
                    clearInterval(window.autorunTimer);
                    $('#startSCAN').prop('disabled', false).text('Start');

                    alert("‚úÖ SCAN AKAN DIHENTIKAN");
                    location.reload();
                } else {
                    // Kalau memang sudah NO, tidak lakukan apa-apa
                    alert("‚ö†Ô∏è SCAN SUDAH NONAKTIF");
                }
        });
            
        // Menampilkan form settingan
        $("#SettingConfig").on("click", function () {
            UIkit.modal("#modal-setting").show(); // Tampilkan modal

            // Generate CEX checkbox + input
            const cexList = Object.keys(CONFIG_CEX || {});
            let cexHtml = '';
            cexList.forEach(cex => {
                cexHtml += `
                <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                    <label for="cex-${cex}" style="min-width:70px; display:inline-block; margin-left:5px;">${cex}</label>
                    <input type="number" class="uk-input uk-form-small cex-modal-input" data-cex="${cex}" value="30" 
                    style="width:80px; display:inline-block; margin-left:8px;" min="0">
                </div>
                `;
            });
            $('#cex-checkbox-group').html(cexHtml);

            // Generate DEX checkbox + input
            const dexList = Object.keys(CONFIG_DEXS || {});
            let dexHtml = '';
            dexList.forEach(dex => {
                dexHtml += `
                <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                    <label for="dex-${dex}" style="min-width:70px; display:inline-block; margin-left:5px;">${dex.toUpperCase()}</label>
                    <input type="number" class="uk-input uk-form-small dex-modal-input" data-dex="${dex}" value="100" 
                    style="width:80px; display:inline-block; margin-left:8px;" min="0">
                </div>
                `;
            });
            $('#dex-checkbox-group').html(dexHtml);

            function loadSettings() {
                let appSettings = getFromLocalStorage('SETTING_SCANNER') || {};

                $('#user').val(appSettings.nickname || '');
                $('#jeda-time-group').val(appSettings.jedaTimeGroup || 500);
                $('#jeda-koin').val(appSettings.jedaKoin || 500);
                $('#walletMeta').val(appSettings.walletMeta || '');
                $('#inFilterPNL').val(appSettings.filterPNL);
                $(`input[name="koin-group"][value="${appSettings.scanPerKoin || 5}"]`).prop('checked', true);
                $(`input[name="waktu-tunggu"][value="${appSettings.speedScan || 2}"]`).prop('checked', true);

                // Perbaiki di sini
                const modalCexs = appSettings.JedaCexs || {};
                $('.cex-modal-input').each(function() {
                    const cex = $(this).data('cex');
                    if (modalCexs[cex] !== undefined) {
                        $(this).val(modalCexs[cex]);
                    }
                });

                const modalDexs = appSettings.JedaDexs || {};
                $('.dex-modal-input').each(function() {
                    const dex = $(this).data('dex');
                    if (modalDexs[dex] !== undefined) {
                        $(this).val(modalDexs[dex]);
                    }
                });
            }

            loadSettings();
        });

// === Toggle: buka Token Management (tampilkan section, sembunyikan scanner) ===
$('#ManajemenKoin').on('click', function(e){
  e.preventDefault();
  // sembunyikan bagian scanner
  $('#scanner-config,#sinyal-container,#header-table').hide();
  $('#dataTableBody').closest('.uk-overflow-auto').hide();

  // tampilkan manajemen
  $('#token-management').show();
  renderTokenManagementList();
});

function renderTokenManagementList() {
  const $tb = $('#mgrTbody').empty();
  let list = getFromLocalStorage('TOKEN_SCANNER', []) || [];
  if (!Array.isArray(list)) list = [];

  const q = ($('#searchMgr').val() || '').toLowerCase();
  const rows = list
    .filter(t => !q || `${t.symbol_in} ${t.symbol_out} ${t.chain}`.toLowerCase().includes(q))
    .map((t,i)=>({ ...t, no: i+1 }));

  // Chip DEX + modal kiri/kanan (maks 4; sisanya "-")
  const dexChips = (row) => {
    const names = (row.selectedDexs || []).slice(0,4);
    while (names.length < 4) names.push(null);
    return names.map(name => {
      if (!name) return `<span class="dex-chip dex-empty">-</span>`;
      const k = String(name);
      const l = row?.dataDexs?.[k]?.left  ?? row?.dataDexs?.[k.toLowerCase()]?.left  ?? 0;
      const r = row?.dataDexs?.[k]?.right ?? row?.dataDexs?.[k.toLowerCase()]?.right ?? 0;
      return `
        <span class="dex-chip">
          <b>${k.toUpperCase()}</b> [
          <span class="dex-mini">${l}</span>
          ~
          <span class="dex-mini">${r}</span>
        ]</span>`;
    }).join(' ');
  };

  rows.forEach(r=>{
    const cexHtml = (r.selectedCexs||[]).map(cx=>{
      const name = String(cx).toUpperCase();
      const col  = (CONFIG_CEX?.[name]?.WARNA) || '#000';
      return `<span class="cex-chip" style="color:${col}">${name}</span>`;
    }).join(' ');

    const chainName = (CONFIG_CHAINS?.[String(r.chain).toLowerCase()]?.Nama_Chain) || r.chain;

    // radio group status (inline, tanpa form)
    const radioGroup = `
      <div class="status-group">
        <label class="uk-text-success">
          <input class="uk-radio mgrStatus" type="radio" 
                 name="status-${r.id}" data-id="${r.id}" value="true" ${r.status ? 'checked':''}>
          ON
        </label>
        <label class="uk-text-danger">
          <input class="uk-radio mgrStatus" type="radio" 
                 name="status-${r.id}" data-id="${r.id}" value="false" ${!r.status ? 'checked':''}>
          OFF
        </label>
      </div>`;

    $tb.append(`
      <tr>
        <td class="uk-text-center">${r.no}</td>

        <td>
          <div>
            <span class="uk-text-bold uk-text-success">${(r.symbol_in||'-').toUpperCase()}</span>
            <span class="addr">${r.sc_in || ''} [${r.des_in ?? ''}]</span>
          </div>
          <div>
            <span class="uk-text-bold uk-text-danger">${(r.symbol_out||'-').toUpperCase()}</span>
            <span class="addr">${r.sc_out || ''} [${r.des_out ?? ''}]</span>
          </div>
        </td>

        <td>
          <div class="uk-text-center uk-margin-small-bottom">${String(chainName).toUpperCase()} ${radioGroup}</div>
          
        </td>

        <td>${cexHtml || '-'}</td>
        <td>${dexChips(r)}</td>

        <td class="actions">
          <button class="uk-button uk-button-primary uk-button-xxsmall mgrEdit" data-id="${r.id}">Edit</button>
        </td>
      </tr>
    `);
  });

  // Edit (pakai modal & builder yang sudah ada)
  $tb.off('click.mgrEdit').on('click.mgrEdit', '.mgrEdit', function(){
    openEditModalById($(this).data('id'));
  });

  // Update status via radio (tanpa form, tanpa confirm)
  $tb.off('change.mgrStatus').on('change.mgrStatus', '.mgrStatus', function(){
    const id = String($(this).data('id'));
    const val = $(this).val() === 'true';
    let tokens = getFromLocalStorage('TOKEN_SCANNER', []) || [];
    const idx = tokens.findIndex(t => String(t.id) === id);
    if (idx === -1) { alert('Data tidak ditemukan'); return; }
    tokens[idx].status = val;
    saveToLocalStorage('TOKEN_SCANNER', tokens);
    try { toastr.success(`Status diubah ke ${val ? 'ACTIVE' : 'INACTIVE'}`); } catch(_) {}
    // tidak perlu re-render penuh; tapi jika ingin sync label lain, boleh panggil:
    // renderTokenManagementList();
  });
}

// inisialisasi
$('#searchMgr').on('input', renderTokenManagementList);
renderTokenManagementList();

$('#btnNewToken').on('click', () => {
  // 1) pilih chain pertama yang punya DEX (fallback: key pertama)
  const keys = Object.keys(window.CONFIG_CHAINS || {});
  const firstChainWithDex =
    keys.find(k => {
      const d = CONFIG_CHAINS[k]?.DEXS;
      return Array.isArray(d) ? d.length > 0 : !!(d && Object.keys(d).length);
    }) || keys[0] || '';

  // siapkan objek kosong
  const empty = {
    id: Date.now().toString(),
    symbol_in:'', des_in:'', sc_in:'',
    symbol_out:'', des_out:'', sc_out:'',
    chain: String(firstChainWithDex || '').toLowerCase(),
    status: true,
    selectedCexs: [],
    selectedDexs: [],
    dataDexs: {},
    dataCexs: {}
  };

  // isi field dasar
  $('#multiTokenIndex').val(empty.id);
  $('#inputSymbolToken, #inputSCToken, #inputSymbolPair, #inputSCPair').val('');
  $('#inputDesToken, #inputDesPair').val('');
  if (typeof setStatusRadios === 'function') setStatusRadios(true);

  // 2) populate combo chain dari CONFIG_CHAINS
  const $sel = $('#FormEditKoinModal #mgrChain');
  if (typeof populateChainSelect === 'function') {
    populateChainSelect($sel, empty.chain); // tampilkan SEMUA chain & pilih default
  } else {
    // fallback sederhana kalau belum punya helper populate
    $sel.empty();
    keys.sort().forEach(k => {
      const item  = CONFIG_CHAINS[k] || {};
      const label = (item.Nama_Chain || item.nama_chain || item.name || k).toString().toUpperCase();
      $sel.append(`<option value="${k.toLowerCase()}">${label}</option>`);
    });
    $sel.val(empty.chain || (keys[0] || '').toLowerCase());
  }

  // ambil chain yang benar-benar terpilih dari select
  const currentChain = String($sel.val() || empty.chain).toLowerCase();
  const baseToken = { ...empty, chain: currentChain };

  // 3) build dari CONFIG
  if (!$('#dex-checkbox-koin').length) console.warn('Kontainer #dex-checkbox-koin tidak ditemukan di modal.');
  if (!$('#cex-checkbox-koin').length) console.warn('Kontainer #cex-checkbox-koin tidak ditemukan di modal.');

  try { buildCexCheckboxForKoin(baseToken); } catch (e) { console.warn('Build CEX gagal:', e); }
  try { buildDexCheckboxForKoin(baseToken); } catch (e) { console.warn('Build DEX gagal:', e); }

  // 4) jika chain diganti ‚Üí rebuild DEX sesuai chain baru
  $sel.off('change.rebuildDexAdd').on('change.rebuildDexAdd', function () {
    const newChain = String($(this).val() || '').toLowerCase();
    try { buildDexCheckboxForKoin({ ...baseToken, chain: newChain }); } catch (_) {}
  });

  // 5) tampilkan modal
  if (window.UIkit?.modal) UIkit.modal('#FormEditKoinModal').show();
  else document.getElementById('FormEditKoinModal').style.display = 'block';
});

    $('#UpdateWalletCEX').on('click', () => {
        if (confirm("APAKAH ANDA INGIN UPDATE WALLET EXCHANGER?")) {
            checkAllCEXWallets();
        }
    }); 


  $("#startSCAN").click(function () {
        // ==== Ambil setting terbaru & daftar chain terpilih ====
        const ConfigScan = getFromLocalStorage('SETTING_SCANNER', {}) || {};
        let allowedChains = Array.isArray(ConfigScan.AllChains) && ConfigScan.AllChains.length
            ? ConfigScan.AllChains.map(c => String(c).toLowerCase())
            : (typeof getManagedChains === 'function' ? getManagedChains() : Object.keys(CONFIG_CHAINS || {}));

        if (!allowedChains || !allowedChains.length) {
            toastr.warning('Tidak ada Chain yang dipilih. Silakan pilih minimal 1 Chain.');
            return;
        }

        // Propagasi ke runtime/global agar loop lain juga menghormati
        try { window.SavedSettingData = ConfigScan; } catch(_) {}
        window.CURRENT_CHAINS = allowedChains;

        // ==== Gunakan urutan saat ini (hasil sorting/filter di UI) ====
        let flatTokens;
        if (Array.isArray(window.filteredTokens) && window.filteredTokens.length) {
            // Hormati pilihan chain terbaru juga
            flatTokens = window.filteredTokens.filter(t =>
                allowedChains.includes(String(t.chain).toLowerCase())
            );
            refreshTokensTable();
        } else {
            const allTokens = getFromLocalStorage("TOKEN_SCANNER", []);
            const flattenedTokens = flattenDataKoin(allTokens);
            flatTokens = flattenedTokens
                .filter(token => allowedChains.includes((token.chain || '').toLowerCase()))
                .sort((a, b) => (a.symbol_in || '').localeCompare(b.symbol_in || '', 'en', { sensitivity: 'base' })); // A‚ÄìZ
            refreshTokensTable(); // opsional, agar tampilan tabel selaras
        }

        // Jika tidak ada token setelah filter, hentikan
        if (!Array.isArray(flatTokens) || flatTokens.length === 0) {
            console.log('Tidak ada token pada chain terpilih atau hasil filter/sort.');
            toastr.info('Tidak ada token pada chain terpilih.');
            $('#startSCAN').prop('disabled', false).text('Start');
            return;
        }

        // Log untuk debugging - memastikan urutan sama
        console.log(`Scanning ${flatTokens.length} tokens in the same order as table display`);

        // ==== Status RUN ====
        let config = { run: 'YES' };
        localStorage.setItem('MULTISCANNER_STATUS_RUN', JSON.stringify(config));

        $('#startSCAN').prop('disabled', true).text('Running...');
        $('#searchInput').val('');

        $('#sinyal-container span[id^="sinyal"]').empty();
        form_off();

        $("#autoScrollCheckbox").show().prop('disabled', false);
        $("#stopSCAN").show().prop('disabled', false);

        $('#LoadDataBtn, #SettingModal, #MasterData,#UpdateWalletCEX, #chain-links-container,.sort-toggle')
            .css('pointer-events', 'none')
            .css('opacity', '0.4');

        $('[id^="EditMulti-"]').css({'pointer-events':'none','opacity':'0.4'}).attr('aria-disabled','true');
        $('.statusCheckbox').css({ 'pointer-events': 'auto', 'opacity': '1' }).prop('disabled', false);

        let scanPerKoin   = parseInt(ConfigScan.scanPerKoin || 1);
        let jedaKoin      = parseInt(ConfigScan.jedaKoin || 500);
        let jedaTimeGroup = parseInt(ConfigScan.jedaTimeGroup || 1000);

        sendStatusTELE(ConfigScan.nickname, 'ONLINE');

        let speedScan = parseInt(getFromLocalStorage('SavedSettingData.speedScan', 500)) * 1000;
        let SavedSettingDataLocal = getFromLocalStorage('SavedSettingData', {});

        // ===== helper jeda DEX dari setting =====
        const settingForDexDelay = window.SavedSettingData || getFromLocalStorage('SETTING_SCANNER', {}) || {};
        const jedaDexMap = (settingForDexDelay && settingForDexDelay.JedaDexs) || {};
        const getJedaDex = (dx) => {
            const v = jedaDexMap[dx];
            const n = parseInt(v);
            return Number.isFinite(n) ? n : 0; // default 0 ms
        };

        // ===== UTIL =====
        function delay(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
        const isPosChecked = (val) => $('input[type="checkbox"][value="'+val+'"]').is(':checked');

        function updateProgress(current, total, startTime, TokenPair) {
            let duration = ((Date.now() - startTime) / 1000 / 60).toFixed(2);
            let progressPercentage = Math.floor((current / total) * 100);
            let progressText = `CHECKING - ${TokenPair} [${current}/${total}] :: Mulai: ${new Date(startTime).toLocaleTimeString()} ~ DURASI [${duration} Menit]`;

            $('#progress-bar').css('width', progressPercentage + '%');
            $('#progress-text').text(progressPercentage + '%');
            $('#progress').text(progressText);
        }

        // Buat ID elemen sel
        function buildIds(cex, dex, tokenPair, pairToken, chainUpper) {
            const dUp = dex.toUpperCase();
            return {
                tokToPairId: `${cex}_${dUp}_${tokenPair}_${chainUpper}`,
                pairToTokId: `${cex}_${dUp}_${pairToken}_${chainUpper}`,
            };
        }

        // Render label BUY/SELL sesuai arah
        function renderBuySellLabels(direction, id, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, cex, NameToken, NamePair) {
            if (direction === 'TokentoPair') {
                $(`span#BUY_${id}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                $(`span#SELL_${id}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
            } else {
                $(`span#BUY_${id}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                $(`span#SELL_${id}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);
            }
        }

        // Handler sukses eksekusi (panggil ResultEksekusi dgn parameter yang tepat)
        function handleDexSuccess(direction, DataDEX, altDataDEX, ctx) {
            const D = altDataDEX || DataDEX; // final data
            if (direction === 'TokentoPair') {
                ResultEksekusi(
                    D.amount_out, D.FeeSwap,
                    ctx.sc_input, ctx.sc_output, ctx.cex,
                    ctx.modalKiri, ctx.amount_in_token,
                    ctx.priceBuyTokenCEX, ctx.priceSellTokenCEX,
                    ctx.priceBuyPairCEX, ctx.priceSellPairCEX,
                    ctx.NameToken, ctx.NamePair,
                    ctx.DataCEX.feeWDToken,
                    ctx.dextype, ctx.nameChain, ctx.codeChain,
                    'TokentoPair', ctx.buyVolToken, D
                );
            } else {
                ResultEksekusi(
                    D.amount_out, D.FeeSwap,
                    ctx.sc_output, ctx.sc_input, ctx.cex,
                    ctx.modalKanan, ctx.amount_in_pair,
                    ctx.priceBuyPairCEX, ctx.priceSellPairCEX,
                    ctx.priceBuyTokenCEX, ctx.priceSellTokenCEX,
                    ctx.NamePair, ctx.NameToken,
                    ctx.DataCEX.feeWDPair,
                    ctx.dextype, ctx.nameChain, ctx.codeChain,
                    'PairtoToken', ctx.sellVolPair, D
                );
            }
        }

        // Handler error + fallback SWOOP (khusus ODOS, rule beda untuk kiri/kanan)
        function handleDexErrorWithFallback(direction, err, ids, ctx) {
            const { tokToPairId, pairToTokId } = ids;
            const targetId = (direction === 'TokentoPair') ? tokToPairId : pairToTokId;

            $(`#${targetId}`).css('background-color', err.color);
            $(`#SWAP_${targetId}`).html(`<span class="uk-text-danger" title="${err.pesanDEX}">[ERROR]</span>`);

            const needFallback = (ctx.dextype === 'odos') &&
                ((direction === 'TokentoPair' && err.statusCode == 500) ||
                (direction === 'PairtoToken' && err.statusCode == 0));

            if (!needFallback) return;

            // siapkan amount_in untuk SWOOP
            if (direction === 'TokentoPair') {
                const amount_in = BigInt(Math.round(Math.pow(10, ctx.des_input) * ctx.amount_in_token));
                getPriceSWOOP(ctx.sc_input, ctx.des_input, ctx.sc_output, ctx.des_output, amount_in,
                    ctx.priceBuyPairCEX, ctx.dextype, ctx.NameToken, ctx.NamePair,
                    ctx.cex, ctx.nameChain, ctx.codeChain, 'TokentoPair',
                    function (altError, altDataDEX) {
                        if (!altError) {
                            $(`#${tokToPairId}`).css('background-color', '#fff35d42');
                            renderBuySellLabels('TokentoPair', tokToPairId,
                                ctx.priceBuyTokenCEX, ctx.priceSellTokenCEX,
                                ctx.priceBuyPairCEX, ctx.priceSellPairCEX,
                                ctx.cex, ctx.NameToken, ctx.NamePair);
                            handleDexSuccess('TokentoPair', null, altDataDEX, ctx);
                        } else {
                            $(`#${tokToPairId}`).css('background-color', altError.color);
                            $(`#SWAP_${tokToPairId}`).html(`<span class="uk-text-danger" title="${altError.pesanDEX}">[ERROR]</span>`);
                        }
                    }
                );
            } else {
                const amount_in = Math.pow(10, ctx.des_output) * ctx.amount_in_pair;
                getPriceSWOOP(ctx.sc_output, ctx.des_output, ctx.sc_input, ctx.des_input, amount_in,
                    ctx.priceBuyPairCEX, ctx.dextype, ctx.NamePair, ctx.NameToken,
                    ctx.cex, ctx.nameChain, ctx.codeChain, 'PairtoToken',
                    function (altError, altDataDEX) {
                        if (!altError) {
                            $(`#${pairToTokId}`).css('background-color', '#fff35d42');
                            renderBuySellLabels('PairtoToken', pairToTokId,
                                ctx.priceBuyTokenCEX, ctx.priceSellTokenCEX,
                                ctx.priceBuyPairCEX, ctx.priceSellPairCEX,
                                ctx.cex, ctx.NameToken, ctx.NamePair);
                            handleDexSuccess('PairtoToken', null, altDataDEX, ctx);
                        } else {
                            $(`#${pairToTokId}`).css('background-color', altError.color);
                            $(`#SWAP_${pairToTokId}`).html(`<span class="uk-text-danger" title="${altError.pesanDEX}">[ERROR]</span>`);
                        }
                    }
                );
            }
        }

        // Panggil DEX dengan jeda, reusable utk kiri/kanan
        function callDexWithDelay(direction, ids, ctx) {
            const { tokToPairId, pairToTokId } = ids;
            const targetId = (direction === 'TokentoPair') ? tokToPairId : pairToTokId;

            // cek elemen & checkbox posisi
            if (!$(`#${targetId}`).length) return;
            if (direction === 'TokentoPair' && !isPosChecked('Actionkiri')) return;
            if (direction === 'PairtoToken' && !isPosChecked('ActionKanan')) return;

            const jedaDEX = getJedaDex(ctx.dextype); // ms

            setTimeout(() => {
                if (direction === 'TokentoPair') {
                    getPriceDEX(
                        ctx.sc_input, ctx.des_input, ctx.sc_output, ctx.des_output,
                        ctx.amount_in_token, ctx.priceBuyPairCEX, ctx.dextype,
                        ctx.NameToken, ctx.NamePair, ctx.cex, ctx.nameChain, ctx.codeChain,
                        'TokentoPair',
                        function (error, DataDEX) {
                            if (error || !DataDEX) {
                                handleDexErrorWithFallback('TokentoPair', error || {}, ids, ctx);
                                return;
                            }
                            renderBuySellLabels('TokentoPair', tokToPairId,
                                ctx.priceBuyTokenCEX, ctx.priceSellTokenCEX,
                                ctx.priceBuyPairCEX, ctx.priceSellPairCEX,
                                ctx.cex, ctx.NameToken, ctx.NamePair);
                            handleDexSuccess('TokentoPair', DataDEX, null, ctx);
                        }
                    );
                } else {
                    getPriceDEX(
                        ctx.sc_output, ctx.des_output, ctx.sc_input, ctx.des_input,
                        ctx.amount_in_pair, ctx.priceBuyPairCEX, ctx.dextype,
                        ctx.NamePair, ctx.NameToken, ctx.cex, ctx.nameChain, ctx.codeChain,
                        'PairtoToken',
                        function (error, DataDEX) {
                            if (error || !DataDEX) {
                                handleDexErrorWithFallback('PairtoToken', error || {}, ids, ctx);
                                return;
                            }
                            renderBuySellLabels('PairtoToken', pairToTokId,
                                ctx.priceBuyTokenCEX, ctx.priceSellTokenCEX,
                                ctx.priceBuyPairCEX, ctx.priceSellPairCEX,
                                ctx.cex, ctx.NameToken, ctx.NamePair);
                            handleDexSuccess('PairtoToken', DataDEX, null, ctx);
                        }
                    );
                }
            }, jedaDEX);
        }

        // ====== PIPELINE PER TOKEN ======
        let maxConcurrentRequests = scanPerKoin;
        let currentRequests = 0;
        let requestQueue = [];

        async function processRequest(token) {
            // Guard tambahan jika token.chain tidak terpilih (keamanan ganda)
            if (!allowedChains.includes(String(token.chain).toLowerCase())) return;

            currentRequests++;
            try {
                let cex = token.cex.toUpperCase();
                let nameChain = token.chain.toUpperCase();
                let codeChain = CONFIG_CHAINS[token.chain.toLowerCase()]?.Kode_Chain;
                let symbolIn = token.symbol_in.toUpperCase();
                let symbolOut = token.symbol_out.toUpperCase();
                let sc_input = token.sc_in.toString();
                let sc_output = token.sc_out.toString();
                let des_input = token.des_in;
                let des_output = token.des_out;
                let NameToken = symbolIn;
                let NamePair = symbolOut;

                let TokenPair = `${symbolIn}_${symbolOut}`;
                let PairToken = `${symbolOut}_${symbolIn}`;

                await new Promise((resolve, reject) => {
                    let timeout = setTimeout(() => reject('Timeout'), speedScan);

                    getPriceCEX(token, token.symbol_in, token.symbol_out, token.cex, (error, DataCEX) => {
                        clearTimeout(timeout);

                        if (error || !DataCEX) {
                            toastr.error(`Cek ulang harga ${token.symbol_in}/${token.symbol_out} di ${token.cex}`);
                            $('#' + token.cex + '_' + TokenPair + '_' + token.chain.toUpperCase())
                                .css('background-color', '#949191');
                            resolve();
                            return;
                        }

                        const priceBuyTokenCEX  = DataCEX.volumes_buyToken?.[0]?.price || 0;
                        const priceSellTokenCEX = DataCEX.volumes_sellToken?.[0]?.price || 0;
                        const priceBuyPairCEX   = DataCEX.volumes_buyPair?.[0]?.price || 0;
                        const priceSellPairCEX  = DataCEX.volumes_sellPair?.[0]?.price || 0;

                        const isInvalid = [priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX]
                            .some(p => !isFinite(p) || p <= 0);

                        if (isInvalid) {
                            toastr.error(`CEK MANUAL ${token.symbol_in} di ${token.cex}`);
                            $('#' + token.cex + '_' + TokenPair + '_' + token.chain.toUpperCase())
                                .css('background-color', '#949191');
                            resolve();
                            return;
                        }

                        const buyVolToken = DataCEX.volumes_buyToken.length > 0
                            ? DataCEX.volumes_buyToken.reduce((min, item) => item.price < min.price ? item : min).volume
                            : 1;

                        const sellVolPair = DataCEX.volumes_sellToken.length > 0
                            ? DataCEX.volumes_sellToken.reduce((max, item) => item.price > max.price ? item : max).volume
                            : 1;

                        // Gunakan data DEX dari token, bukan dari localStorage
                        if (token.dexs && Array.isArray(token.dexs)) {
                            token.dexs.forEach((dexData) => {
                                const dex        = dexData.dex;
                                const modalKiri  = dexData.left;    // Modal kiri dari data token
                                const modalKanan = dexData.right;   // Modal kanan dari data token

                                const ids = buildIds(cex, dex, TokenPair, PairToken, token.chain.toUpperCase());
                                const dextype = dex.toLowerCase();

                                // Perhitungan untuk modal kiri dan kanan
                                const amount_in_token = parseFloat(modalKiri)  / parseFloat(priceBuyTokenCEX);
                                const amount_in_pair  = parseFloat(modalKanan) / parseFloat(priceBuyPairCEX);

                                const ctx = {
                                    // general
                                    cex, nameChain, codeChain, dextype,
                                    NameToken, NamePair, DataCEX,
                                    sc_input, sc_output, des_input, des_output,
                                    // prices
                                    priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX,
                                    // modals & amounts
                                    modalKiri, modalKanan, amount_in_token, amount_in_pair,
                                    // volumes
                                    buyVolToken, sellVolPair
                                };

                                // panggil DEX untuk kedua arah (dengan delay per-DEX)
                                callDexWithDelay('TokentoPair', ids, ctx);
                                callDexWithDelay('PairtoToken', ids, ctx);
                            });
                        }

                        resolve();
                    });
                });

                await delay(jedaKoin);
            } catch (error) {
                console.error(`Kesalahan saat memproses ${token.symbol_in}_${token.symbol_out}:`, error);
            } finally {
                currentRequests--;
                if (requestQueue.length > 0) {
                    let nextRequest = requestQueue.shift();
                    nextRequest();
                }
            }
        }

        // ====== ORKESTRASI ======
        async function processTokens() {
            let startTime = Date.now();
            let totalTokens = flatTokens.length;
            let currentProcessed = 0;

            let tokenGroups = [];
            for (let i = 0; i < flatTokens.length; i += scanPerKoin) {
                tokenGroups.push(flatTokens.slice(i, i + scanPerKoin));
            }

            for (let groupIndex = 0; groupIndex < tokenGroups.length; groupIndex++) {
                let groupTokens = tokenGroups[groupIndex];
                console.log(`Memproses grup ${groupIndex + 1} dari ${tokenGroups.length}`);
                console.log("anggota grup",groupTokens);
                // üîπ Auto Scroll sekali di awal grup
                if ($('#autoScrollCheckbox').is(':checked')) {
                    const first = groupTokens[0];
                    const rowId = `DETAIL_${first.cex.toUpperCase()}_${first.symbol_in.toUpperCase()}_${first.symbol_out.toUpperCase()}_${first.chain.toUpperCase()}`.replace(/[^A-Z0-9_]/g,'');
                    const target = document.getElementById(rowId);
                    const container = document.querySelector('.uk-overflow-auto');

                        if (target) {
                            target.classList.add('auto-focus'); setTimeout(()=>target.classList.remove('auto-focus'), 900);
                            if (container) {
                            const top = target.offsetTop - (container.clientHeight/2);
                            container.scrollTo({ top: Math.max(top,0), behavior: 'smooth' });
                            } else {
                            target.scrollIntoView({ behavior:'smooth', block:'center' });
                            }
                        }
                        console.log("scanning..",rowId);
                    }
                feeGasGwei();
                getRateUSDT();

                for (let tokenIndex = 0; tokenIndex < groupTokens.length; tokenIndex++) {
                    let token = groupTokens[tokenIndex];

                    updateProgress(
                        currentProcessed + tokenIndex + 1,
                        totalTokens,
                        startTime,
                        `${token.symbol_in}_${token.symbol_out}`
                    );

                    if (currentRequests >= scanPerKoin) {
                        await new Promise(resolve => requestQueue.push(resolve));
                    }

                    await processRequest(token);
                }

                currentProcessed += groupTokens.length;
                console.log(`Grup ${groupIndex + 1} selesai diproses`);
                await delay(jedaTimeGroup);
            }

            updateProgress(totalTokens, totalTokens, startTime, 'SELESAI');
            form_on();
            $("#stopSCAN").hide().prop("disabled", false);
            config.run = 'NO';
            localStorage.setItem('MULTISCANNER_STATUS_RUN', JSON.stringify(config));
            $('#startSCAN').prop('disabled', false).text('Start');
            $("#LoadDataBtn, #SettingModal, #MasterData,#UpdateWalletCEX,#chain-links-container,.sort-toggle")
                .css("pointer-events", "auto").css("opacity", "1");
            $('[id^="EditMulti-"]').css({'pointer-events':'auto','opacity':'1'}).removeAttr('aria-disabled');
        }

        processTokens();
    });


});

</script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.6.22/dist/js/uikit.min.js"></script>
</body>
</html>
